{"version":3,"sources":["../src/providers.ts","../src/utils/utils.ts","../src/client.ts","../src/tools/create-tool.ts","../src/agent.ts"],"names":["createProvider","config","model","provider","Providers","randomId","hyperid","parseTemplate","template","context","match","key","stripModelName","modelString","parts","stripProviderName","hasTag","content","tag","stripTag","openTagRegex","closeTagRegex","extractInnerTag","regex","isBufferString","str","slugify","text","takeRight","array","n","cleanEmptyList","item","sanitizeProvider","sanitized","firstCharacters","lastCharacters","total","prefix","suffix","maskedLength","Defaults","Micro","options","providerConfig","providerFn","axios","prompt","msg","limit","systemPromptMessage","restOfMessages","limitMessages","limitedHistory","messages","bufferString","parsedPrompt","requestBody","tool","thinkingBudgetMap","response","toolName","toolArguments","t","errorMessage","parsedArgs","result","error","toolCalls","toolCall","startTime","responseData","message","latencyMs","reasoning","hasThoughts","errorResponse","createTool","name","description","schema","executeFn","jsonSchema","zodToJsonSchema","properties","required","SYSTEM_PROMPT_EXTRA","dedent","AgentDefaults","Agent","_Agent","sections","toolsText","agents","agent","z","tools","Orchestrator","_Orchestrator"],"mappings":"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","file":"index.cjs","sourcesContent":["import type { Provider } from './types'\n\n/**\n * Create a provider configuration object\n * Separates the model from the provider config for internal use\n */\nexport function createProvider(config: Provider): {\n  provider: Omit<Provider, 'model'>\n  model: string\n} {\n  const { model, ...provider } = config\n  return { provider, model }\n}\n\n/**\n * Built-in provider configurations\n * Each provider includes API endpoint, authentication, and default model\n */\nexport const Providers = {\n  openai: (model = 'gpt-4.1-mini'): Provider => ({\n    apiKey: process.env.OPENAI_API_KEY || '',\n    baseURL: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1',\n    model,\n  }),\n\n  groq: (model = 'llama-3.3-70b-versatile'): Provider => ({\n    apiKey: process.env.GROQ_API_KEY || '',\n    baseURL: process.env.GROQ_BASE_URL || 'https://api.groq.com/openai/v1',\n    model,\n  }),\n\n  gemini: (model = 'gemini-2.5-flash-lite'): Provider => ({\n    apiKey: process.env.GEMINI_API_KEY || '',\n    baseURL:\n      process.env.GEMINI_BASE_URL ||\n      'https://generativelanguage.googleapis.com/v1beta/openai',\n    model,\n  }),\n\n  ai302: (model = 'gpt-4o-mini'): Provider => ({\n    apiKey: process.env.AI_302_API_KEY || '',\n    baseURL: process.env.AI_302_BASE_URL || 'https://api.302.ai/v1',\n    model,\n  }),\n\n  openrouter: (model = 'anthropic/claude-haiku-4.5'): Provider => ({\n    apiKey: process.env.OPENROUTER_API_KEY || '',\n    baseURL: process.env.OPENROUTER_BASE_URL || 'https://openrouter.ai/api/v1',\n    model,\n  }),\n\n  deepseek: (model = 'deepseek-chat'): Provider => ({\n    apiKey: process.env.DEEPSEEK_API_KEY || '',\n    baseURL: process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com/v1',\n    model,\n  }),\n\n  grok: (model = 'grok-4-fast'): Provider => ({\n    apiKey: process.env.GROK_API_KEY || '',\n    baseURL: process.env.GROK_BASE_URL || 'https://api.x.ai/v1',\n    model,\n  }),\n}\n","import hyperid from 'hyperid'\nimport { Provider } from '../types'\n\n/**\n * Generate a random ID using crypto.randomUUID\n */\nexport function randomId(): string {\n  const id = hyperid({ urlSafe: true })\n  return id()\n}\n\n/**\n * Parse template string and replace {{variable}} placeholders with context values\n * @param template - Template string with {{variable}} placeholders\n * @param context - Object containing variable values\n * @returns Parsed string with variables replaced\n */\nexport function parseTemplate(\n  template: string,\n  context: Record<string, any> = {}\n): string {\n  return template.replace(/\\{\\{(\\w+)\\}\\}/g, (match, key) => {\n    return context[key] !== undefined ? String(context[key]) : match\n  })\n}\n\n/**\n * Extract model name from \"provider:model\" format\n * @param modelString - Full model string (e.g., \"openai:gpt-4.1-mini\")\n * @returns Model name only (e.g., \"gpt-4o-mini\")\n */\nexport function stripModelName(modelString: string): string {\n  const parts = modelString.split(':')\n  return parts.length > 1 ? (parts[1] ?? modelString) : modelString\n}\n\n/**\n * Extract provider name from \"provider:model\" format\n * @param modelString - Full model string (e.g., \"openai:gpt-4.1-mini\")\n * @returns Provider name only (e.g., \"openai\")\n */\nexport function stripProviderName(modelString: string): string {\n  const parts = modelString.split(':')\n  return parts.length > 1 ? (parts[0] ?? '') : ''\n}\n\n/**\n * Check if content contains a specific XML-style tag\n * @param content - Content to check\n * @param tag - Tag name to look for\n * @returns True if tag is found\n */\nexport function hasTag(content: string, tag: string): boolean {\n  const regex = new RegExp(`<${tag}>`, 'i')\n  return regex.test(content)\n}\n\n/**\n * Remove XML-style tags from content\n * @param content - Content with tags\n * @param tag - Tag name to remove\n * @returns Content without the specified tags\n */\nexport function stripTag(content: string, tag: string): string {\n  const openTagRegex = new RegExp(`<${tag}>`, 'gi')\n  const closeTagRegex = new RegExp(`</${tag}>`, 'gi')\n  return content.replace(openTagRegex, '').replace(closeTagRegex, '')\n}\n\n/**\n * Extract content within XML-style tags\n * @param content - Content with tags\n * @param tag - Tag name to extract\n * @returns Content within the tags, or empty string if not found\n */\nexport function extractInnerTag(content: string, tag: string): string {\n  const regex = new RegExp(`<${tag}>(.*?)</${tag}>`, 'is')\n  const match = content.match(regex)\n  return match && match[1] ? match[1].trim() : ''\n}\n\n/**\n * Check if a string is a base64-encoded buffer string (data URL)\n * @param str - String to check\n * @returns True if string is a buffer string\n */\nexport function isBufferString(str: string): boolean {\n  return str.startsWith('data:') && str.includes(';base64,')\n}\n\n/**\n * Detect MIME type from a buffer string (data URL)\n * @param bufferString - Base64 buffer string\n * @returns MIME type (e.g., \"image/png\") or empty string if not detected\n */\nexport function detectMimeTypeFromBufferString(bufferString: string): string {\n  if (!isBufferString(bufferString)) {\n    return ''\n  }\n\n  const match = bufferString.match(/^data:([^;]+);base64,/)\n  return match && match[1] ? match[1] : ''\n}\n\n/**\n * Convert a string to a URL-friendly slug\n * @param text - Text to slugify\n * @returns Slugified text (lowercase, hyphens, alphanumeric)\n */\nexport function slugify(text: string): string {\n  return text\n    .toLowerCase()\n    .trim()\n    .replace(/[^\\w\\s-]/g, '')\n    .replace(/[\\s_-]+/g, '-')\n    .replace(/^-+|-+$/g, '')\n}\n\n/**\n * Get the last n elements from an array\n * @param array - Array to take elements from\n * @param n - Number of elements to take from the end\n * @returns New array with the last n elements\n */\nexport function takeRight<T>(array: T[], n: number = 1): T[] {\n  if (n <= 0) return []\n  if (n >= array.length) return [...array]\n  return array.slice(-n)\n}\n\n/**\n * Remove empty strings from an array\n * @param array - Array of strings to filter\n * @returns New array with empty strings removed\n */\nexport function cleanEmptyList(array: string[]): string[] {\n  return array.filter((item) => item !== '')\n}\n\n/**\n * Log a labeled message with a visual separator\n * @param label - Label to display above the logged content\n * @param args - Arguments to log after the label and separator\n */\nexport function microlog(label: string, ...args: any[]): void {\n  console.log(`\\n${label}`)\n  console.log('='.repeat(50))\n  console.log(...args)\n  console.log('='.repeat(50) + '\\n')\n}\n\n/**\n * Sanitize a provider object by masking sensitive API key information (in logs or CLI)\n * @param provider - Provider object without model property\n * @returns Sanitized provider object with masked API key\n */\nexport function sanitizeProvider(provider: Omit<Provider, 'model'>): any {\n  if (!provider) return provider\n\n  const sanitized = { ...provider }\n\n  if (sanitized.apiKey && typeof sanitized.apiKey === 'string') {\n    const key = sanitized.apiKey\n    // Show first 10 chars, mask the rest except last 8 chars\n    const firstCharacters = 10\n    const lastCharacters = 8\n    const total = firstCharacters + lastCharacters\n\n    if (key.length > total) {\n      const prefix = key.substring(0, firstCharacters)\n      const suffix = key.substring(key.length - lastCharacters)\n      const maskedLength = key.length - total\n      sanitized.apiKey = `${prefix}${'•'.repeat(maskedLength)}${suffix}`\n    } else if (key.length > firstCharacters) {\n      const prefix = key.substring(0, firstCharacters)\n      sanitized.apiKey = `${prefix}${'•'.repeat(key.length - firstCharacters)}`\n    } else {\n      sanitized.apiKey = '•'.repeat(key.length)\n    }\n  }\n\n  return sanitized\n}\n","import 'dotenv/config'\nimport axios, { AxiosInstance } from 'axios'\nimport type {\n  MicroOptions,\n  Message,\n  Provider,\n  ReasoningLevel,\n  Metadata,\n  Response,\n} from './types'\nimport { Providers } from './providers'\nimport {\n  randomId,\n  parseTemplate,\n  stripModelName,\n  stripProviderName,\n  isBufferString,\n  hasTag,\n  stripTag,\n  extractInnerTag,\n  takeRight,\n  sanitizeProvider,\n} from './utils/utils'\n\nconst Defaults = {\n  apiKey: process.env.OPENAI_API_KEY || '',\n  baseURL: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1',\n  providerName: 'openai',\n  model: 'gpt-4o-mini',\n  temperature: 0,\n  defaultEndpointCompletionSuffix: '/chat/completions',\n}\n\nexport class Micro {\n  private axiosInstance: AxiosInstance\n  private model: string\n  private systemPrompt: string\n  private messages: Message[]\n  private context: Record<string, any>\n  private prompt: string\n  private maxTokens?: number\n  private temperature?: number\n  private tools?: MicroOptions['tools']\n  private tool_choice?: MicroOptions['tool_choice']\n  private streaming: boolean\n  private parsedSystemPrompt: string\n  private defaultProvider: Omit<Provider, 'model'>\n  private modelName: string\n  private providerName: string\n  private identifier: string\n  private timeout?: number\n  private reasoning_effort?: ReasoningLevel\n\n  private onComplete?: MicroOptions['onComplete']\n  private onMessage?: MicroOptions['onMessage']\n  private onRequest?: MicroOptions['onRequest']\n  private onResponseData?: MicroOptions['onResponseData']\n  private onError?: MicroOptions['onError']\n  private onToolCall?: MicroOptions['onToolCall']\n\n  private debug: boolean\n\n  private reasoning: boolean\n  private isReasoningModel: boolean\n  private isGemini25Reasoning: boolean\n  private isOpenAIReasoning: boolean\n  private isOpenAI5: boolean\n  private isGLMReasoning: boolean\n  private isQWQ: boolean\n  private isDeepseekReasoning: boolean\n  private isQwen3: boolean\n\n  constructor(options: MicroOptions = {}) {\n    this.identifier = randomId()\n    this.timeout = options?.timeout\n\n    this.modelName = stripModelName(options?.model || '') || Defaults.model\n    this.providerName =\n      stripProviderName(options?.model || '') || Defaults.providerName\n\n    let providerConfig: Provider | undefined\n    if (this.providerName) {\n      const providerFn = Providers[this.providerName as keyof typeof Providers]\n      if (providerFn) {\n        providerConfig = providerFn(this.modelName)\n      }\n    }\n\n    this.defaultProvider = {\n      baseURL:\n        providerConfig?.baseURL ??\n        options?.provider?.baseURL ??\n        Defaults.baseURL,\n      apiKey:\n        providerConfig?.apiKey ?? options?.provider?.apiKey ?? Defaults.apiKey,\n      ...(options?.provider?.headers && {\n        headers: options.provider.headers,\n      }),\n    }\n\n    if (!this.defaultProvider.apiKey) {\n      throw new Error('API Key is required')\n    }\n\n    this.axiosInstance = axios.create({\n      baseURL: this.defaultProvider.baseURL,\n      headers: {\n        Authorization: `Bearer ${this.defaultProvider.apiKey}`,\n        'Content-Type': 'application/json',\n        ...this.defaultProvider.headers,\n      },\n      ...(this.timeout && {\n        timeout: this.timeout,\n      }),\n    })\n\n    this.model = this.modelName\n    this.systemPrompt = options?.systemPrompt || ''\n    this.prompt = options?.prompt || ''\n\n    this.context = options.context ?? {}\n    this.parsedSystemPrompt = this.systemPrompt\n      ? parseTemplate(this.systemPrompt, this.context)\n      : ''\n    this.maxTokens = options.maxTokens\n    this.temperature =\n      options.temperature !== undefined\n        ? options.temperature\n        : Defaults.temperature\n    this.tools = options.tools\n    this.tool_choice = options.tool_choice\n\n    this.debug = options?.debug || false\n    this.streaming = options?.streaming || false\n\n    this.reasoning = options?.reasoning ?? true\n    this.reasoning_effort = options.reasoning_effort ?? 'medium'\n\n    this.isOpenAI5 = this.model?.toLowerCase()?.includes('gpt-5')\n    this.isOpenAIReasoning =\n      this.model?.toLowerCase()?.includes('o1') ||\n      this.model?.toLowerCase()?.includes('o3') ||\n      this.model?.toLowerCase()?.includes('o4') ||\n      this.isOpenAI5\n\n    this.isGemini25Reasoning = this.model?.toLowerCase()?.includes('gemini-2.5')\n\n    this.isGLMReasoning = this.model?.toLowerCase()?.includes('glm-4.')\n    this.isQWQ = this.model?.toLowerCase()?.includes('qwq')\n    this.isDeepseekReasoning =\n      this.model?.toLowerCase()?.includes('deepseek-reasoner') ||\n      this.model?.toLowerCase()?.includes('deepseek-r1')\n    this.isQwen3 = this.model?.toLowerCase()?.includes('qwen3')\n\n    this.isReasoningModel =\n      this.isGemini25Reasoning ||\n      this.isOpenAIReasoning ||\n      this.isGLMReasoning ||\n      this.isQWQ ||\n      this.isDeepseekReasoning ||\n      this.isQwen3\n\n    this.onComplete = options.onComplete || undefined\n    this.onMessage = options.onMessage || undefined\n    this.onRequest = options.onRequest || undefined\n    this.onResponseData = options.onResponseData || undefined\n    this.onError = options.onError || undefined\n    this.onToolCall = options.onToolCall || undefined\n\n    this.messages = options?.messages ?? []\n    this.setSystemPrompt(this.parsedSystemPrompt)\n\n    if (this.debug) {\n      console.log('\\n=============================================')\n      console.log('Micro INFO:')\n      console.log('=============================================')\n      console.log('IDENTIFIER:      ', this.identifier)\n      console.log('MODEL NAME:      ', this.modelName)\n      console.log('PROVIDER NAME:   ', this.providerName)\n      console.log('DEFAULT PROVIDER ', sanitizeProvider(this.defaultProvider))\n      console.log('=============================================\\n')\n    }\n  }\n\n  public getMetadata(): Metadata {\n    return {\n      id: this.identifier,\n      prompt: this.prompt,\n      providerName: this.providerName,\n      model: this.modelName,\n      timing: {\n        latencyMs: 0,\n        latencySeconds: 0,\n      },\n      timestamp: new Date().toISOString(),\n      context: this.context,\n      ...(this.isReasoningModel && {\n        isReasoningEnabled: this.reasoning,\n        isReasoningModel: this.isReasoningModel,\n        reasoning_effort: this.reasoning_effort,\n      }),\n    }\n  }\n\n  public getSystemPrompt(): string {\n    return this.parsedSystemPrompt\n  }\n\n  public setSystemPrompt(prompt: string): void {\n    if (!prompt) return\n    this.parsedSystemPrompt = parseTemplate(prompt, this.context)\n    if (this.parsedSystemPrompt && !this.getSystemMessage().length) {\n      this.messages.unshift({\n        role: 'system',\n        content: this.parsedSystemPrompt,\n      })\n    }\n  }\n\n  private getSystemMessage(): Message[] {\n    return this.messages.filter((msg) => msg.role === 'system')\n  }\n\n  private getNonSystemMessages(): Message[] {\n    return this.messages.filter((msg) => msg.role !== 'system')\n  }\n\n  public flushAllMessages(): void {\n    this.messages = []\n  }\n\n  public limitMessages(limit: number = 5): Message[] {\n    const systemPromptMessage = this.getSystemMessage()\n    const restOfMessages = this.getNonSystemMessages()\n    const limitMessages = takeRight(restOfMessages, limit)\n    const limitedHistory = [...systemPromptMessage, ...limitMessages]\n    this.messages = limitedHistory\n    return this.messages\n  }\n\n  public getMessages(): Message[] {\n    return this.messages\n  }\n\n  public setMessages(messages: Message[]): void {\n    this.messages = messages\n  }\n\n  public setUserMessage(prompt: string, bufferString?: string): void {\n    const parsedPrompt = parseTemplate(prompt, this.context)\n    this.prompt = parsedPrompt\n\n    if (bufferString && isBufferString(bufferString)) {\n      this.messages.push({\n        role: 'user',\n        content: [\n          {\n            type: 'text',\n            text: parsedPrompt,\n          },\n          {\n            type: 'image_url',\n            image_url: {\n              url: bufferString,\n            },\n          },\n        ],\n      })\n    } else {\n      this.messages.push({\n        role: 'user',\n        content: parsedPrompt,\n      })\n    }\n\n    if (this.onMessage) {\n      this.onMessage(this.messages)\n    }\n  }\n\n  public setAssistantMessage(prompt: string): this {\n    const parsedPrompt = parseTemplate(prompt, this.context)\n\n    this.messages.push({\n      role: 'assistant',\n      content: parsedPrompt,\n    })\n\n    if (this.onMessage) {\n      this.onMessage(this.messages)\n    }\n\n    return this\n  }\n\n  private async makeRequest(): Promise<Record<string, any>> {\n    const requestBody: any = {\n      model: this.model,\n      messages: this.messages,\n      stream: this.streaming,\n    }\n\n    if (this.temperature) {\n      requestBody.temperature = this.temperature\n    }\n\n    if (this.maxTokens) {\n      requestBody.max_tokens = this.maxTokens\n    }\n\n    if (this.tools && this.tools.length > 0) {\n      requestBody.tools = this.tools.map((tool) => tool.schema)\n      if (this.tool_choice) {\n        requestBody.tool_choice = this.tool_choice\n      }\n    }\n\n    if (this.reasoning && this.isReasoningModel) {\n      if (this.isOpenAIReasoning) {\n        requestBody.reasoning_effort = this.reasoning_effort\n        if (this.maxTokens) {\n          requestBody.max_completion_tokens = this.maxTokens\n          delete requestBody.max_tokens\n        }\n      } else if (this.isGemini25Reasoning) {\n        const thinkingBudgetMap: Record<ReasoningLevel, number> = {\n          minimal: 2048,\n          low: 4096,\n          medium: 8192,\n          high: 16384,\n        }\n        requestBody.extra_body = {\n          google: {\n            thinking_config: {\n              thinking_budget:\n                thinkingBudgetMap[this.reasoning_effort || 'medium'],\n              include_thoughts: true,\n            },\n          },\n        }\n      } else if (this.isGLMReasoning) {\n        requestBody.thinking = {\n          type: 'enabled',\n        }\n      }\n    }\n\n    if (this.onRequest) {\n      this.onRequest(requestBody)\n    }\n\n    const response = await this.axiosInstance.post(\n      Defaults.defaultEndpointCompletionSuffix,\n      requestBody\n    )\n\n    if (this.onResponseData) {\n      this.onResponseData(response.data)\n    }\n\n    return response.data\n  }\n\n  private async executeTool(\n    toolName: string,\n    toolArguments: string\n  ): Promise<any> {\n    const tool = this.tools?.find((t) => t.schema.function.name === toolName)\n\n    if (!tool) {\n      const errorMessage = `Tool \"${toolName}\" not found`\n      if (this.onToolCall) {\n        this.onToolCall({\n          toolName,\n          arguments: toolArguments,\n          result: null,\n          error: errorMessage,\n        })\n      }\n      return errorMessage\n    }\n\n    try {\n      const parsedArgs = JSON.parse(toolArguments)\n      const result = await tool.execute(parsedArgs)\n\n      if (this.onToolCall) {\n        this.onToolCall({\n          toolName,\n          arguments: parsedArgs,\n          result,\n        })\n      }\n\n      return result\n    } catch (error: any) {\n      const errorMessage = `Error executing tool \"${toolName}\": ${error.message}`\n      if (this.onToolCall) {\n        this.onToolCall({\n          toolName,\n          arguments: toolArguments,\n          result: null,\n          error: errorMessage,\n        })\n      }\n      return errorMessage\n    }\n  }\n\n  private async handleToolCalls(toolCalls: any[]): Promise<void> {\n    for (const toolCall of toolCalls) {\n      const toolName = toolCall.function.name\n      const toolArguments = toolCall.function.arguments\n\n      const result = await this.executeTool(toolName, toolArguments)\n\n      this.messages.push({\n        role: 'tool',\n        tool_call_id: toolCall.id,\n        name: toolName,\n        content: typeof result === 'string' ? result : JSON.stringify(result),\n      })\n\n      if (this.onMessage) {\n        this.onMessage(this.messages)\n      }\n    }\n  }\n\n  public async invoke(): Promise<Response> {\n    const startTime = Date.now()\n\n    try {\n      const responseData = await this.makeRequest()\n\n      const choice = responseData.choices?.[0]\n      const message = choice?.message\n\n      if (message) {\n        this.messages.push(message)\n\n        if (this.onMessage) {\n          this.onMessage(this.messages)\n        }\n      }\n\n      if (message?.tool_calls && message.tool_calls.length > 0) {\n        await this.handleToolCalls(message.tool_calls)\n        return this.invoke()\n      }\n\n      const endTime = Date.now()\n      const latencyMs = endTime - startTime\n\n      let reasoning = ''\n      let content = message?.content || ''\n      let hasThoughts = false\n\n      if (this.reasoning && this.isReasoningModel && content) {\n        if (hasTag(content, 'thinking')) {\n          reasoning = extractInnerTag(content, 'thinking')\n          content = stripTag(content, 'thinking')\n          hasThoughts = true\n        } else if (hasTag(content, 'think')) {\n          reasoning = extractInnerTag(content, 'think')\n          content = stripTag(content, 'think')\n          hasThoughts = true\n        }\n      }\n\n      const response: Response = {\n        metadata: {\n          id: this.identifier,\n          prompt: this.prompt,\n          providerName: this.providerName,\n          model: this.modelName,\n          tokensUsed: responseData.usage,\n          timing: {\n            latencyMs,\n            latencySeconds: latencyMs / 1000,\n          },\n          timestamp: new Date().toISOString(),\n          context: this.context,\n          ...(this.isReasoningModel && {\n            isReasoningEnabled: this.reasoning,\n            isReasoningModel: this.isReasoningModel,\n            reasoning_effort: this.reasoning_effort,\n            hasThoughts,\n          }),\n        },\n        fullResponse: responseData,\n        completion: {\n          role: message?.role || 'assistant',\n          content: content.trim(),\n          reasoning: reasoning.trim(),\n          original: message?.content || '',\n        },\n      }\n\n      if (this.onComplete) {\n        this.onComplete(response, this.messages)\n      }\n\n      return response\n    } catch (error: any) {\n      const endTime = Date.now()\n      const latencyMs = endTime - startTime\n\n      const errorResponse: Response = {\n        metadata: {\n          id: this.identifier,\n          prompt: this.prompt,\n          providerName: this.providerName,\n          model: this.modelName,\n          timing: {\n            latencyMs,\n            latencySeconds: latencyMs / 1000,\n          },\n          timestamp: new Date().toISOString(),\n          context: this.context,\n        },\n        completion: {\n          role: 'assistant',\n          content: '',\n          original: '',\n        },\n        error: {\n          type: error.code === 'ECONNABORTED' ? 'timeout' : 'api_error',\n          message: error.message,\n          status: error.response?.status,\n          code: error.code,\n          details: error.response?.data,\n        },\n      }\n\n      if (this.onError) {\n        this.onError(errorResponse.error)\n      }\n\n      return Promise.reject(errorResponse.error)\n    }\n  }\n\n  public async chat(prompt: string, bufferString?: string): Promise<Response> {\n    this.setUserMessage(prompt, bufferString)\n    return this.invoke()\n  }\n}\n","import { type z } from 'zod'\nimport { zodToJsonSchema } from 'zod-to-json-schema'\n\nimport type { Tool } from '../types'\n\n/**\n * Creates a tool that can be used by agents to perform specific actions.\n *\n * @param name - The name of the tool\n * @param description - A description of what the tool does\n * @param schema - A trod schema defining the tool's parameters\n * @param executeFn - The function to execute when the tool is called\n * @returns A Tool object with schema and execute function\n *\n * @example\n * ```typescript\n * const weatherTool = createTool(\n *   \"get_weather\",\n *   \"Get the current weather for a location\",\n *   z.object({\n *     location: z.string().describe(\"The city and state, e.g. San Francisco, CA\"),\n *     unit: z.enum([\"celsius\", \"fahrenheit\"]).optional()\n *   }),\n *   async (params) => {\n *     return `Weather in ${params.location}: 72°F, sunny`;\n *   }\n * );\n * ```\n */\nexport function createTool<T extends z.ZodTypeAny, R>(\n  name: string,\n  description: string,\n  schema: T,\n  executeFn: (params: z.infer<T>) => Promise<R> | R\n): Tool {\n  const jsonSchema = zodToJsonSchema(schema as any, {\n    target: 'openApi3',\n    $refStrategy: 'none',\n  })\n\n  const properties = (jsonSchema as any).properties || {}\n  const required = (jsonSchema as any).required || []\n\n  return {\n    schema: {\n      type: 'function',\n      function: {\n        name,\n        description,\n        parameters: {\n          type: 'object',\n          properties,\n          required,\n          additionalProperties: false,\n        },\n      },\n    },\n    execute: executeFn,\n  }\n}\n","import dedent from 'dedent'\nimport { z } from 'zod'\nimport { Micro } from './client'\nimport type { MicroOptions, Tool, Message, Metadata, Response } from './types'\nimport { createTool } from './tools/create-tool'\nimport { cleanEmptyList, slugify } from './utils/utils'\n\nconst SYSTEM_PROMPT_EXTRA = dedent`\nYou should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.\nYou should first think about it, then if necessary, use the tools to get the information you need.\nGo back and forth between the tools and the context until you have a complete understanding of the task.\nDo not repeat the same tool call in consecutive calls.\nNow begin!\n`\n\nexport type AgentOptions = Omit<MicroOptions, 'prompt'> & {\n  name: string\n  background: string\n  goal?: string\n  position?: string\n  additionalInstructions?: string\n  handoffs?: Agent[]\n}\n\nconst AgentDefaults = {\n  model: 'gpt-4o-mini',\n}\n\nexport class Agent {\n  private client: Micro\n  public name: string\n  public background: string\n  public goal: string | undefined\n  public position: string | undefined\n  public handoffs?: Agent[]\n  public tools?: Tool[]\n  public model: string | undefined\n\n  constructor(options: AgentOptions) {\n    this.name = options.name\n    this.background = options.background\n    this.goal = options.goal\n    this.handoffs = options.handoffs || []\n    this.tools = options.tools || []\n    this.position = options.position\n    this.model = options.model\n\n    const context = {\n      role: options.name,\n      background: options.background,\n      goal: options.goal,\n      additionalInstructions: options.additionalInstructions,\n      toolsList: cleanEmptyList([\n        this.handoffAgentToStringList(this.handoffs),\n        this.toolsToStringList(this.tools),\n      ]),\n      ...(options.context || {}),\n    }\n\n    this.client = new Micro({\n      systemPrompt: this.buildSystemPrompt({\n        role: context.role,\n        background: context.background,\n        goal: context.goal,\n        additionalInstructions: context.additionalInstructions,\n        toolsList: context.toolsList || [],\n      }),\n      maxTokens: options.maxTokens || 4000,\n      temperature: options.temperature ?? 0,\n      model: this.model || AgentDefaults.model,\n      debug: options.debug || false,\n      context: context,\n      messages: options.messages,\n      reasoning: options.reasoning,\n      reasoning_effort: options.reasoning_effort,\n      timeout: options.timeout,\n      streaming: options.streaming,\n      tool_choice: options.tool_choice,\n      onComplete: options.onComplete,\n      onMessage: options.onMessage,\n      onRequest: options.onRequest,\n      onResponseData: options.onResponseData,\n      onError: options.onError,\n      onToolCall: options.onToolCall,\n      ...(this.handoffs && this.handoffs.length > 0\n        ? {\n            tools: [\n              ...(options.tools || []),\n              ...this.handoffAgentToTools(this.handoffs),\n            ],\n          }\n        : { tools: options.tools }),\n    })\n  }\n\n  private buildSystemPrompt(options: {\n    role?: string\n    background?: string\n    goal?: string\n    additionalInstructions?: string\n    toolsList?: string[]\n  }): string {\n    const sections: string[] = []\n\n    if (options?.role) {\n      sections.push(`# ROLE\\nYou are a ${options.role}.`)\n    }\n\n    if (options?.background) {\n      sections.push(`## BACKGROUND\\n${options.background}.`)\n    }\n\n    if (options?.goal) {\n      sections.push(`## MAIN GOAL\\n${options.goal}`)\n    }\n\n    if (options?.additionalInstructions) {\n      sections.push(\n        `## ADDITIONAL INSTRUCTIONS\\n${options.additionalInstructions}`\n      )\n    }\n\n    const toolsText = options?.toolsList?.length\n      ? options.toolsList.join(', ')\n      : '\\n - None provided'\n    sections.push(\n      `## TOOL HINTS\\nYou have access to the following tools: ${toolsText}`\n    )\n\n    sections.push(SYSTEM_PROMPT_EXTRA)\n\n    return sections.join('\\n\\n')\n  }\n\n  private handoffAgentToTools(agents: Agent[]): Tool[] {\n    return agents.map((agent) =>\n      createTool(\n        slugify(agent.name),\n        dedent`You are a ${agent.name}. Use this tool to ${agent.goal ?? agent.background}`,\n        z.object({\n          prompt: z.string().describe('The prompt of the request.'),\n        }),\n        async ({ prompt }) => {\n          const response = await agent.chat(prompt)\n          return response?.completion?.content || response\n        }\n      )\n    )\n  }\n\n  private toolsToStringList(tools: Tool[]): string {\n    if (!tools || tools.length === 0) {\n      return ''\n    }\n    return (\n      '\\n' +\n      tools\n        .map(\n          (tool) =>\n            `- ${tool.schema.function.name} [${slugify(tool.schema.function.name)}]: Its role is to ${\n              tool.schema.function.description\n            }`\n        )\n        .join('\\n')\n    )\n  }\n\n  private handoffAgentToStringList(agents: Agent[]): string {\n    if (!agents || agents.length === 0) {\n      return ''\n    }\n    return (\n      '\\n' +\n      agents\n        .map(\n          (agent) =>\n            `- ${agent.name} [${slugify(agent.name)}]: Its role is to ${\n              agent.background\n            }`\n        )\n        .join('\\n')\n    )\n  }\n\n  public async invoke(): Promise<Response> {\n    return this.client.invoke()\n  }\n\n  public async chat(prompt: string): Promise<Response> {\n    this.addPrompt(prompt)\n    return this.client.invoke()\n  }\n\n  public getMessages(): Message[] {\n    return this.client.getMessages()\n  }\n\n  public addPrompt(msg: string): void {\n    this.client.setUserMessage(msg)\n  }\n\n  public addAssistantPrompt(msg: string): void {\n    this.client.setAssistantMessage(msg)\n  }\n\n  public getMetadata(): Metadata {\n    return this.client.getMetadata()\n  }\n\n  public static create(options: AgentOptions): Agent {\n    return new Agent(options)\n  }\n}\n\nexport class Orchestrator extends Agent {\n  constructor(options: AgentOptions) {\n    super({ ...options, position: 'orchestrator' })\n  }\n\n  public static create(options: AgentOptions): Orchestrator {\n    return new Orchestrator({ ...options, position: 'orchestrator' })\n  }\n}\n"]}