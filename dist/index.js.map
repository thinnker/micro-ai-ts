{"version":3,"sources":["../src/client.ts","../src/providers.ts","../src/http.ts","../src/utils/utils.ts","../src/tools/create-tool.ts","../src/agent.ts","../src/orchestrator.ts","../src/tools/mcp-client.ts","../src/tools/mcp-adapter.ts"],"names":["createProvider","config","model","provider","Providers","http_exports","__export","del","get","head","httpClient","options","patch","post","put","METHODS_WITH_BODY","request","baseURL","endpoint","headers","body","timeout","method","stream","controller","timeoutId","fetchOptions","response","errorData","error","timeoutError","randomId","parseTemplate","template","context","match","key","stripModelName","modelString","parts","stripProviderName","hasTag","content","tag","stripTag","openTagRegex","closeTagRegex","extractInnerTag","regex","isBufferString","str","slugify","text","takeRight","array","n","cleanEmptyList","item","sanitizeProvider","sanitized","firstCharacters","lastCharacters","total","prefix","suffix","maskedLength","Defaults","Micro","providerFn","providerConfig","modelLower","isOpenAI5","isOpenAIReasoning","v","isGemini25Reasoning","isGLMReasoning","isQWQ","isDeepseekReasoning","isQwen3","isMinimaxM2","prompt","hasSystemMessage","msg","limit","systemMessages","otherMessages","limitedMessages","messages","bufferString","parsedPrompt","enableStream","tool","thinkingBudgetMap","requestBody","data","toolName","toolArguments","t","errorMessage","parsedArgs","result","toolCalls","toolExecutions","toolCall","toolResults","message","reasoning","responseData","latencyMs","startTime","errorResponse","tokensUsed","reader","decoder","fullContent","role","buffer","done","value","lines","line","trimmedLine","parsed","delta","toolCallDelta","index","deltaReasoning","metadata","completion","finalResponse","iteration","hasToolCalls","chunk","lastMessage","createTool","name","description","schema","executeFn","jsonSchema","zodToJsonSchema","properties","required","SYSTEM_PROMPT_EXTRA","dedent","AgentDefaults","Agent","_Agent","sections","toolsText","agents","agent","z","tools","Orchestrator","_Orchestrator","MCP_REQUEST_TIMEOUT_MS","MCPClient","resolve","reject","spawn","code","pending","params","id","args","jsonSchemaToZod","shape","fieldSchema","activeMCPClients","cleanupMCPClients","clients","client","disconnectAllMCPClients","createMCPTools","toolNames","mcpTools","toolsToCreate","mcpTool","zodSchema","createMCPTool"],"mappings":"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","file":"index.js","sourcesContent":["import 'dotenv/config'\nimport type {\n  MicroOptions,\n  Message,\n  Provider,\n  ReasoningLevel,\n  Metadata,\n  Response,\n  StreamResponse,\n  MessageRole,\n  ModelCapabilities,\n  LlmParams,\n  ToolCall,\n} from './types'\nimport { Providers } from './providers'\nimport { httpClient } from './http'\nimport {\n  randomId,\n  parseTemplate,\n  stripModelName,\n  stripProviderName,\n  isBufferString,\n  hasTag,\n  stripTag,\n  extractInnerTag,\n  takeRight,\n  sanitizeProvider,\n} from './utils/utils'\n\nconst Defaults = {\n  apiKey: process.env.OPENAI_API_KEY || '',\n  baseURL: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1',\n  providerName: 'openai',\n  model: 'gpt-4.1-mini',\n  defaultEndpointCompletionSuffix: '/chat/completions',\n}\n\nexport class Micro {\n  private readonly identifier: string\n  private readonly baseURL: string\n  private readonly headers: Record<string, string>\n  private readonly model: string\n  private readonly modelName: string\n  private readonly providerName: string\n  private readonly defaultProvider: Omit<Provider, 'model'>\n  private readonly capabilities: ModelCapabilities\n  private readonly debug: boolean\n  private readonly streamEnabled: boolean\n  private readonly timeout?: number\n\n  private systemPrompt: string\n  private parsedSystemPrompt: string\n  private messages: Message[]\n  private context: Record<string, any>\n  private prompt: string\n  private maxTokens?: number\n  private temperature?: number\n  private tools?: MicroOptions['tools']\n  private tool_choice?: MicroOptions['tool_choice']\n  private reasoning: boolean\n  private reasoning_effort?: ReasoningLevel\n  private override?: LlmParams & Record<string, any>\n  private maxToolInterations: number\n\n  private onComplete?: MicroOptions['onComplete']\n  private onMessage?: MicroOptions['onMessage']\n  private onRequest?: MicroOptions['onRequest']\n  private onResponseData?: MicroOptions['onResponseData']\n  private onError?: MicroOptions['onError']\n  private onToolCall?: MicroOptions['onToolCall']\n\n  constructor(options: MicroOptions = {}) {\n    this.identifier = randomId()\n    this.timeout = options.timeout ?? 120000\n    this.debug = options.debug ?? false\n    this.maxToolInterations = options.maxToolInterations ?? 10\n    this.streamEnabled = options.stream ?? false\n\n    this.modelName = stripModelName(options.model || '') || Defaults.model\n    this.providerName =\n      stripProviderName(options.model || '') || Defaults.providerName\n    this.model = this.modelName\n\n    this.defaultProvider = this.initializeProvider(options)\n    this.baseURL = this.defaultProvider.baseURL\n    this.headers = this.buildHeaders()\n\n    this.capabilities = this.detectModelCapabilities()\n    this.reasoning = options.reasoning ?? this.capabilities.isReasoningModel\n    this.reasoning_effort = this.reasoning\n      ? (options.reasoning_effort ?? 'medium')\n      : undefined\n\n    this.systemPrompt = options.systemPrompt || ''\n    this.prompt = options.prompt || ''\n    this.context = options.context ?? {}\n    this.parsedSystemPrompt = this.systemPrompt\n      ? parseTemplate(this.systemPrompt, this.context)\n      : ''\n\n    this.maxTokens = options.maxTokens\n    this.temperature = options.temperature\n    this.tools = options.tools\n    this.tool_choice = options.tool_choice\n\n    this.override = options.override\n\n    this.onComplete = options.onComplete\n    this.onMessage = options.onMessage\n    this.onRequest = options.onRequest\n    this.onResponseData = options.onResponseData\n    this.onError = options.onError\n    this.onToolCall = options.onToolCall\n\n    this.messages = options.messages ?? []\n    this.setSystemPrompt(this.parsedSystemPrompt)\n\n    if (this.debug) this.logDebugInfo()\n  }\n\n  private initializeProvider(options: MicroOptions): Omit<Provider, 'model'> {\n    const providerFn = Providers[this.providerName as keyof typeof Providers]\n    const providerConfig = providerFn?.(this.modelName)\n\n    const provider = {\n      baseURL:\n        providerConfig?.baseURL ??\n        options.provider?.baseURL ??\n        Defaults.baseURL,\n      apiKey:\n        providerConfig?.apiKey ?? options.provider?.apiKey ?? Defaults.apiKey,\n      ...(options.provider?.headers && { headers: options.provider.headers }),\n    }\n\n    if (!provider.apiKey) {\n      throw new Error('API Key is required')\n    }\n\n    return provider\n  }\n\n  private buildHeaders(): Record<string, string> {\n    return {\n      Authorization: `Bearer ${this.defaultProvider.apiKey}`,\n      'Content-Type': 'application/json',\n      ...this.defaultProvider.headers,\n    }\n  }\n\n  private detectModelCapabilities(): ModelCapabilities {\n    const modelLower = this.model.toLowerCase()\n\n    const isOpenAI5 = modelLower.includes('gpt-5')\n    const isOpenAIReasoning =\n      ['o1', 'o3', 'o4'].some((v) => modelLower.includes(v)) || isOpenAI5\n    const isGemini25Reasoning = modelLower.includes('gemini-2.5')\n    const isGLMReasoning = modelLower.includes('glm-4.')\n    const isQWQ = modelLower.includes('qwq')\n    const isDeepseekReasoning =\n      modelLower.includes('deepseek-reasoner') ||\n      modelLower.includes('deepseek-r1')\n    const isQwen3 = modelLower.includes('qwen3')\n    const isMinimaxM2 = modelLower.includes('-m2')\n\n    const isReasoningModel =\n      isGemini25Reasoning ||\n      isOpenAIReasoning ||\n      isGLMReasoning ||\n      isQWQ ||\n      isDeepseekReasoning ||\n      isQwen3 ||\n      isMinimaxM2\n\n    return {\n      isOpenAI5,\n      isOpenAIReasoning,\n      isGemini25Reasoning,\n      isGLMReasoning,\n      isQWQ,\n      isDeepseekReasoning,\n      isQwen3,\n      isMinimaxM2,\n      isReasoningModel,\n    }\n  }\n\n  private logDebugInfo(): void {\n    console.log('\\n=============================================')\n    console.log('Micro INFO:')\n    console.log('=============================================')\n    console.log('IDENTIFIER:      ', this.identifier)\n    console.log('MODEL NAME:      ', this.modelName)\n    console.log('PROVIDER NAME:   ', this.providerName)\n    console.log('DEFAULT PROVIDER ', sanitizeProvider(this.defaultProvider))\n    console.log('=============================================\\n')\n  }\n\n  public getMetadata(): Metadata {\n    return {\n      id: this.identifier,\n      prompt: this.prompt,\n      providerName: this.providerName,\n      model: this.modelName,\n      timing: {\n        latencyMs: 0,\n        latencySeconds: 0,\n      },\n      timestamp: new Date().toISOString(),\n      context: this.context,\n      ...(this.capabilities.isReasoningModel && {\n        isReasoningEnabled: this.reasoning,\n        isReasoningModel: this.capabilities.isReasoningModel,\n        ...(this.reasoning_effort && {\n          reasoning_effort: this.reasoning_effort,\n        }),\n      }),\n    }\n  }\n\n  public getSystemPrompt(): string {\n    return this.parsedSystemPrompt\n  }\n\n  public setSystemPrompt(prompt: string): void {\n    if (!prompt) return\n    this.parsedSystemPrompt = parseTemplate(prompt, this.context)\n\n    const hasSystemMessage = this.messages.some((msg) => msg.role === 'system')\n    if (this.parsedSystemPrompt && !hasSystemMessage) {\n      this.messages.unshift({\n        role: 'system',\n        content: this.parsedSystemPrompt,\n      })\n    }\n  }\n\n  private getSystemMessage(): Message[] {\n    return this.messages.filter((msg) => msg.role === 'system')\n  }\n\n  private getNonSystemMessages(): Message[] {\n    return this.messages.filter((msg) => msg.role !== 'system')\n  }\n\n  public flushAllMessages(): void {\n    this.messages = []\n  }\n\n  public limitMessages(limit: number = 5): Message[] {\n    const systemMessages = this.getSystemMessage()\n    const otherMessages = this.getNonSystemMessages()\n    const limitedMessages = takeRight(otherMessages, limit)\n\n    this.messages = [...systemMessages, ...limitedMessages]\n    return this.messages\n  }\n\n  public getMessages(): Message[] {\n    return this.messages\n  }\n\n  public setMessages(messages: Message[]): void {\n    this.messages = messages\n  }\n\n  public setUserMessage(prompt: string, bufferString?: string): void {\n    const parsedPrompt = parseTemplate(prompt, this.context)\n    this.prompt = parsedPrompt\n\n    const content =\n      bufferString && isBufferString(bufferString)\n        ? [\n            { type: 'text' as const, text: parsedPrompt },\n            { type: 'image_url' as const, image_url: { url: bufferString } },\n          ]\n        : parsedPrompt\n\n    this.messages.push({ role: 'user', content })\n    this.onMessage?.(this.messages)\n  }\n\n  public setAssistantMessage(prompt: string): this {\n    const parsedPrompt = parseTemplate(prompt, this.context)\n    this.messages.push({ role: 'assistant', content: parsedPrompt })\n    this.onMessage?.(this.messages)\n    return this\n  }\n\n  private buildRequestBody(enableStream: boolean): Record<string, any> {\n    let body: Record<string, any> = {\n      model: this.model,\n      messages: this.messages,\n      stream: enableStream || this.streamEnabled,\n    }\n\n    if (this.temperature !== undefined) body.temperature = this.temperature\n    if (this.maxTokens) body.max_tokens = this.maxTokens\n\n    if (this.tools?.length) {\n      body.tools = this.tools.map((tool) => tool.schema)\n      if (this.tool_choice) body.tool_choice = this.tool_choice\n    }\n\n    if (this.reasoning && this.capabilities.isReasoningModel) {\n      this.applyReasoningConfig(body)\n    }\n    if (this.override) {\n      body = { ...body, ...this.override }\n    }\n\n    return body\n  }\n\n  private applyReasoningConfig(body: Record<string, any>): void {\n    if (this.capabilities.isOpenAIReasoning) {\n      body.reasoning_effort = this.reasoning_effort\n      if (this.maxTokens) {\n        body.max_completion_tokens = this.maxTokens\n        delete body.max_tokens\n      }\n    } else if (this.capabilities.isGemini25Reasoning) {\n      const thinkingBudgetMap: Record<ReasoningLevel, number> = {\n        minimal: 2048,\n        low: 4096,\n        medium: 8192,\n        high: 16384,\n      }\n      body.extra_body = {\n        google: {\n          thinking_config: {\n            thinking_budget:\n              thinkingBudgetMap[this.reasoning_effort || 'medium'],\n            include_thoughts: true,\n          },\n        },\n      }\n    } else if (this.capabilities.isGLMReasoning) {\n      body.thinking = { type: 'enabled' }\n    }\n  }\n\n  private async makeRequest(\n    enableStream: boolean = false\n  ): Promise<Record<string, any> | Response> {\n    const requestBody = this.buildRequestBody(enableStream)\n    this.onRequest?.(requestBody)\n\n    const data = await httpClient({\n      baseURL: this.baseURL,\n      endpoint: Defaults.defaultEndpointCompletionSuffix,\n      headers: this.headers,\n      body: requestBody,\n      timeout: this.timeout,\n      method: 'POST',\n      stream: enableStream || this.streamEnabled,\n    })\n\n    if (!enableStream) this.onResponseData?.(data)\n    return data\n  }\n\n  private async executeTool(\n    toolName: string,\n    toolArguments: string\n  ): Promise<any> {\n    const tool = this.tools?.find((t) => t.schema.function.name === toolName)\n\n    if (!tool) {\n      const errorMessage = `Tool \"${toolName}\" not found`\n      this.onToolCall?.({\n        toolName,\n        arguments: toolArguments,\n        result: null,\n        error: errorMessage,\n      })\n      return errorMessage\n    }\n\n    try {\n      const parsedArgs = JSON.parse(toolArguments)\n      const result = await tool.execute(parsedArgs)\n      this.onToolCall?.({ toolName, arguments: parsedArgs, result })\n      return result\n    } catch (error: any) {\n      const errorMessage = `Error executing tool \"${toolName}\": ${error.message}`\n      this.onToolCall?.({\n        toolName,\n        arguments: toolArguments,\n        result: null,\n        error: errorMessage,\n      })\n      return errorMessage\n    }\n  }\n\n  private async handleToolCalls(toolCalls: any[]): Promise<void> {\n    const toolExecutions = toolCalls.map(async (toolCall) => {\n      const result = await this.executeTool(\n        toolCall.function.name,\n        toolCall.function.arguments\n      )\n\n      return {\n        role: 'tool' as const,\n        tool_call_id: toolCall.id,\n        name: toolCall.function.name,\n        content: typeof result === 'string' ? result : JSON.stringify(result),\n      }\n    })\n\n    const toolResults = await Promise.all(toolExecutions)\n\n    this.messages.push(...toolResults)\n    this.onMessage?.(this.messages)\n  }\n\n  private extractReasoning(message: any): {\n    reasoning: string\n    content: string\n  } {\n    let reasoning = message?.reasoning || message?.reasoning_content || ''\n    let content = message?.content || ''\n\n    if (hasTag(content, 'thinking')) {\n      reasoning = extractInnerTag(content, 'thinking')\n      content = stripTag(content, 'thinking')\n    } else if (hasTag(content, 'thought')) {\n      reasoning = extractInnerTag(content, 'thought')\n      content = stripTag(content, 'thought')\n    }\n\n    return { reasoning, content }\n  }\n\n  private buildResponse(\n    responseData: Record<string, any>,\n    latencyMs: number,\n    reasoning: string,\n    content: string,\n    message: any\n  ): Response {\n    return {\n      metadata: {\n        id: this.identifier,\n        prompt: this.prompt,\n        providerName: this.providerName,\n        model: this.modelName,\n        tokensUsed: responseData.usage,\n        timing: {\n          latencyMs,\n          latencySeconds: latencyMs / 1000,\n        },\n        timestamp: new Date().toISOString(),\n        context: this.context,\n        isReasoningEnabled: this.reasoning,\n        isReasoningModel:\n          this.capabilities.isReasoningModel || reasoning.length > 0,\n        ...(this.reasoning_effort && {\n          reasoning_effort: this.reasoning_effort,\n        }),\n        hasThoughts: reasoning.length > 0,\n      },\n      fullResponse: responseData,\n      completion: {\n        role: message?.role || 'assistant',\n        content: content.trim(),\n        reasoning: reasoning.trim(),\n        original: message?.content || '',\n      },\n    }\n  }\n\n  private buildErrorResponse(error: any, latencyMs: number): Response {\n    return {\n      metadata: {\n        id: this.identifier,\n        prompt: this.prompt,\n        providerName: this.providerName,\n        model: this.modelName,\n        timing: {\n          latencyMs,\n          latencySeconds: latencyMs / 1000,\n        },\n        timestamp: new Date().toISOString(),\n        context: this.context,\n      },\n      completion: {\n        role: 'assistant',\n        content: '',\n        original: '',\n      },\n      error: {\n        type: error.code === 'ECONNABORTED' ? 'timeout' : 'api_error',\n        message: error.message,\n        status: error.response?.status,\n        code: error.code,\n        details: error.response?.data,\n      },\n    }\n  }\n\n  public async invoke(): Promise<Response> {\n    const startTime = Date.now()\n\n    try {\n      const responseData = (await this.makeRequest()) as Record<string, any>\n      const message = responseData.choices?.[0]?.message\n\n      if (message) {\n        this.messages.push(message)\n        this.onMessage?.(this.messages)\n      }\n\n      if (message?.tool_calls?.length) {\n        await this.handleToolCalls(message.tool_calls)\n        return this.invoke()\n      }\n\n      const latencyMs = Date.now() - startTime\n      const { reasoning, content } = this.extractReasoning(message)\n      const response = this.buildResponse(\n        responseData,\n        latencyMs,\n        reasoning,\n        content,\n        message\n      )\n\n      this.onComplete?.(response, this.messages)\n      return response\n    } catch (error: any) {\n      const latencyMs = Date.now() - startTime\n      const errorResponse = this.buildErrorResponse(error, latencyMs)\n\n      this.onError?.(errorResponse.error)\n      return Promise.reject(errorResponse.error)\n    }\n  }\n\n  public async chat(prompt: string, bufferString?: string): Promise<Response> {\n    this.setUserMessage(prompt, bufferString)\n    return this.invoke()\n  }\n\n  private buildStreamMetadata(\n    latencyMs: number,\n    tokensUsed: any,\n    reasoning: string\n  ): Metadata {\n    return {\n      id: this.identifier,\n      prompt: this.prompt,\n      providerName: this.providerName,\n      model: this.modelName,\n      tokensUsed,\n      timing: {\n        latencyMs,\n        latencySeconds: latencyMs / 1000,\n      },\n      timestamp: new Date().toISOString(),\n      context: this.context,\n      isReasoningEnabled: this.reasoning,\n      isReasoningModel: this.capabilities.isReasoningModel,\n      ...(this.reasoning_effort && {\n        reasoning_effort: this.reasoning_effort,\n      }),\n      hasThoughts: reasoning.length > 0,\n    }\n  }\n\n  private async *processStream(\n    response: Response,\n    startTime: number\n  ): StreamResponse {\n    const reader = (response as any).body?.getReader()\n    if (!reader) throw new Error('Stream not available')\n\n    const decoder = new TextDecoder()\n    let fullContent = ''\n    let reasoning = ''\n    let role = 'assistant'\n    let buffer = ''\n    let tokensUsed: any = undefined\n    let toolCalls: ToolCall[] = []\n\n    try {\n      while (true) {\n        const { done, value } = await reader.read()\n        if (done) break\n\n        buffer += decoder.decode(value, { stream: true })\n        const lines = buffer.split('\\n')\n        buffer = lines.pop() || ''\n\n        for (const line of lines) {\n          const trimmedLine = line.trim()\n          if (!trimmedLine || trimmedLine === 'data: [DONE]') continue\n\n          if (trimmedLine.startsWith('data: ')) {\n            try {\n              const parsed = JSON.parse(trimmedLine.slice(6))\n              const delta = parsed.choices?.[0]?.delta\n              if (this.debug && delta) {\n                console.log(\n                  'STREAM: Received delta:',\n                  JSON.stringify(delta, null, 2)\n                )\n              }\n\n              if (delta?.role) role = delta.role\n\n              if (delta?.tool_calls) {\n                for (const toolCallDelta of delta.tool_calls) {\n                  const index = toolCallDelta.index ?? toolCalls.length\n                  if (!toolCalls[index]) {\n                    toolCalls[index] = {\n                      id: toolCallDelta.id || '',\n                      type: 'function',\n                      function: {\n                        name: toolCallDelta.function?.name || '',\n                        arguments: toolCallDelta.function?.arguments || '',\n                      },\n                    }\n                  } else {\n                    if (toolCallDelta.id) toolCalls[index].id = toolCallDelta.id\n                    if (toolCallDelta.function?.name)\n                      toolCalls[index].function.name =\n                        toolCallDelta.function.name\n                    if (toolCallDelta.function?.arguments)\n                      toolCalls[index].function.arguments +=\n                        toolCallDelta.function.arguments\n                  }\n                }\n              }\n\n              const deltaReasoning =\n                delta?.reasoning || delta?.reasoning_content\n              if (delta?.content || deltaReasoning) {\n                fullContent += delta.content || ''\n                reasoning += deltaReasoning || ''\n\n                yield {\n                  delta: delta.content,\n                  reasoning: deltaReasoning,\n                  fullContent,\n                  done: false,\n                }\n              }\n\n              if (parsed.usage) tokensUsed = parsed.usage\n            } catch {\n              // Skip invalid JSON\n            }\n          }\n        }\n      }\n\n      const message: Message = {\n        role: role as MessageRole,\n        content: fullContent,\n      }\n      if (toolCalls.length > 0) {\n        message.tool_calls = toolCalls\n      }\n\n      this.messages.push(message)\n      this.onMessage?.(this.messages)\n\n      const latencyMs = Date.now() - startTime\n      const metadata = this.buildStreamMetadata(\n        latencyMs,\n        tokensUsed,\n        reasoning\n      )\n      const completion = {\n        role,\n        content: fullContent.trim(),\n        reasoning: reasoning.trim(),\n        original: fullContent,\n      }\n\n      const finalResponse: Response = { metadata, completion }\n      this.onComplete?.(finalResponse, this.messages)\n\n      yield {\n        delta: '',\n        fullContent: fullContent.trim(),\n        reasoning: reasoning.trim(),\n        done: true,\n        metadata,\n        completion,\n      }\n    } catch (error: any) {\n      const latencyMs = Date.now() - startTime\n      const errorResponse = this.buildErrorResponse(error, latencyMs)\n\n      this.onError?.(errorResponse.error)\n      throw errorResponse.error\n    }\n  }\n\n  public async stream(\n    prompt: string,\n    bufferString?: string\n  ): Promise<StreamResponse> {\n    this.setUserMessage(prompt, bufferString)\n    return this.streamWithToolHandling()\n  }\n\n  private async *streamWithToolHandling(): StreamResponse {\n    let iteration = 0\n\n    while (iteration < this.maxToolInterations) {\n      iteration++\n      const startTime = Date.now()\n\n      try {\n        const response = await this.makeRequest(true)\n        const stream = this.processStream(response as Response, startTime)\n\n        let hasToolCalls = false\n\n        for await (const chunk of stream) {\n          if (chunk.done) {\n            const lastMessage = this.messages[this.messages.length - 1]\n            if (lastMessage?.tool_calls?.length) {\n              hasToolCalls = true\n            } else {\n              // No tool calls, yield the final chunk\n              yield chunk\n            }\n          } else {\n            // Yield non-final chunks immediately\n            yield chunk\n          }\n        }\n\n        if (hasToolCalls) {\n          const lastMessage = this.messages[this.messages.length - 1]\n          if (lastMessage?.tool_calls) {\n            await this.handleToolCalls(lastMessage.tool_calls)\n          }\n\n          continue\n        }\n\n        break\n      } catch (error: any) {\n        const latencyMs = Date.now() - startTime\n        const errorResponse = this.buildErrorResponse(error, latencyMs)\n        this.onError?.(errorResponse.error)\n        throw errorResponse.error\n      }\n    }\n\n    if (iteration >= this.maxToolInterations) {\n      throw new Error('Max tool call iterations reached')\n    }\n  }\n}\n","import type { Provider } from './types'\n\n/**\n * Create a provider configuration object\n * Separates the model from the provider config for internal use\n */\nexport function createProvider(config: Provider): {\n  provider: Omit<Provider, 'model'>\n  model: string\n} {\n  const { model, ...provider } = config\n  return { provider, model }\n}\n\n/**\n * Built-in provider configurations\n * Each provider includes API endpoint, authentication, and default model\n */\nexport const Providers = {\n  openai: (model = 'gpt-4.1-mini'): Provider => ({\n    apiKey: process.env.OPENAI_API_KEY || '',\n    baseURL: process.env.OPENAI_BASE_URL || 'https://api.openai.com/v1',\n    model,\n  }),\n\n  groq: (model = 'llama-3.3-70b-versatile'): Provider => ({\n    apiKey: process.env.GROQ_API_KEY || '',\n    baseURL: process.env.GROQ_BASE_URL || 'https://api.groq.com/openai/v1',\n    model,\n  }),\n\n  gemini: (model = 'gemini-2.5-flash-lite'): Provider => ({\n    apiKey: process.env.GEMINI_API_KEY || '',\n    baseURL:\n      process.env.GEMINI_BASE_URL ||\n      'https://generativelanguage.googleapis.com/v1beta/openai',\n    model,\n  }),\n\n  ai302: (model = 'gpt-4.1-mini'): Provider => ({\n    apiKey: process.env.AI_302_API_KEY || '',\n    baseURL: process.env.AI_302_BASE_URL || 'https://api.302.ai/v1',\n    model,\n  }),\n\n  openrouter: (model = 'openai/gpt-4.1-mini'): Provider => ({\n    apiKey: process.env.OPENROUTER_API_KEY || '',\n    baseURL: process.env.OPENROUTER_BASE_URL || 'https://openrouter.ai/api/v1',\n    model,\n  }),\n\n  deepseek: (model = 'deepseek-chat'): Provider => ({\n    apiKey: process.env.DEEPSEEK_API_KEY || '',\n    baseURL: process.env.DEEPSEEK_BASE_URL || 'https://api.deepseek.com/v1',\n    model,\n  }),\n\n  grok: (model = 'grok-4-fast'): Provider => ({\n    apiKey: process.env.GROK_API_KEY || '',\n    baseURL: process.env.GROK_BASE_URL || 'https://api.x.ai/v1',\n    model,\n  }),\n\n  fireworks: (\n    model = 'accounts/fireworks/models/llama4-maverick-instruct-basic'\n  ): Provider => ({\n    apiKey: process.env.FIREWORKS_API_KEY || '',\n    baseURL:\n      process.env.FIREWORKS_BASE_URL || 'https://api.fireworks.ai/inference/v1',\n    model,\n  }),\n\n  mistral: (model = 'mistral-large-latest'): Provider => ({\n    apiKey: process.env.MISTRAL_API_KEY || '',\n    baseURL: process.env.MISTRAL_BASE_URL || 'https://api.mistral.ai/v1',\n    model,\n  }),\n\n  together: (\n    model = 'meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo'\n  ): Provider => ({\n    apiKey: process.env.TOGETHER_API_KEY || '',\n    baseURL: process.env.TOGETHER_BASE_URL || 'https://api.together.xyz/v1',\n    model,\n  }),\n\n  nscale: (model = 'meta-llama/Llama-3.1-8B-Instruct'): Provider => ({\n    apiKey: process.env.NSCALE_API_KEY || '',\n    baseURL:\n      process.env.NSCALE_BASE_URL || 'https://inference.api.nscale.com/v1',\n    model,\n  }),\n\n  minimax: (model = 'MiniMax-M2'): Provider => ({\n    apiKey: process.env.MINIMAX_API_KEY || '',\n    baseURL: process.env.MINIMAX_BASE_URL || 'https://api.minimax.io/v1',\n    model,\n  }),\n}\n","export type HttpMethod =\n  | 'get'\n  | 'GET'\n  | 'delete'\n  | 'DELETE'\n  | 'head'\n  | 'HEAD'\n  | 'options'\n  | 'OPTIONS'\n  | 'post'\n  | 'POST'\n  | 'put'\n  | 'PUT'\n  | 'patch'\n  | 'PATCH'\n\nexport interface HttpClientOptions {\n  baseURL: string\n  endpoint: string\n  headers: Record<string, string>\n  body?: Record<string, any>\n  timeout?: number\n  method?: HttpMethod\n  stream?: boolean\n}\n\nexport interface HttpError extends Error {\n  response?: {\n    status: number\n    data: any\n  }\n  code?: string\n}\n\nconst METHODS_WITH_BODY: HttpMethod[] = [\n  'POST',\n  'post',\n  'PUT',\n  'put',\n  'PATCH',\n  'patch',\n]\n\nasync function request<T = any>(options: HttpClientOptions): Promise<T> {\n  const {\n    baseURL,\n    endpoint,\n    headers,\n    body,\n    timeout,\n    method = 'POST',\n    stream = false,\n  } = options\n\n  const controller = new AbortController()\n  const timeoutId = timeout\n    ? setTimeout(() => controller.abort(), timeout)\n    : undefined\n\n  try {\n    const fetchOptions: RequestInit = {\n      method,\n      headers,\n      signal: controller.signal,\n    }\n\n    if (body && METHODS_WITH_BODY.includes(method)) {\n      fetchOptions.body = JSON.stringify(body)\n    }\n\n    const response = await fetch(`${baseURL}${endpoint}`, fetchOptions)\n\n    if (timeoutId) {\n      clearTimeout(timeoutId)\n    }\n\n    if (!response.ok) {\n      const errorData = await response.json().catch(() => ({}))\n      const error = new Error(\n        errorData.error?.message || `HTTP error! status: ${response.status}`\n      ) as HttpError\n      error.response = {\n        status: response.status,\n        data: errorData,\n      }\n      error.code = 'HTTP_ERROR'\n      throw error\n    }\n\n    if (stream) {\n      return response as T\n    }\n\n    return await response.json()\n  } catch (error: any) {\n    if (timeoutId) {\n      clearTimeout(timeoutId)\n    }\n\n    if (error.name === 'AbortError') {\n      const timeoutError = new Error('Request timeout') as HttpError\n      timeoutError.code = 'ECONNABORTED'\n      throw timeoutError\n    }\n\n    throw error\n  }\n}\n\nexport async function httpClient<T = any>(\n  options: HttpClientOptions\n): Promise<T> {\n  return request<T>(options)\n}\n\nexport async function get<T = any>(\n  options: Omit<HttpClientOptions, 'body' | 'method'>\n): Promise<T> {\n  return request<T>({ ...options, method: 'GET' })\n}\n\nexport async function post<T = any>(options: HttpClientOptions): Promise<T> {\n  return request<T>({ ...options, method: 'POST' })\n}\n\nexport async function put<T = any>(options: HttpClientOptions): Promise<T> {\n  return request<T>({ ...options, method: 'PUT' })\n}\n\nexport async function patch<T = any>(options: HttpClientOptions): Promise<T> {\n  return request<T>({ ...options, method: 'PATCH' })\n}\n\nexport async function del<T = any>(\n  options: Omit<HttpClientOptions, 'body' | 'method'>\n): Promise<T> {\n  return request<T>({ ...options, method: 'DELETE' })\n}\n\nexport async function head<T = any>(\n  options: Omit<HttpClientOptions, 'body' | 'method'>\n): Promise<T> {\n  return request<T>({ ...options, method: 'HEAD' })\n}\n\nexport async function options<T = any>(\n  options: Omit<HttpClientOptions, 'body' | 'method'>\n): Promise<T> {\n  return request<T>({ ...options, method: 'OPTIONS' })\n}\n","import { Provider } from '../types'\n\n/**\n * Generate a random ID using crypto.randomUUID\n */\nexport function randomId(): string {\n  return crypto.randomUUID()\n}\n\n/**\n * Parse template string and replace {{variable}} placeholders with context values\n * @param template - Template string with {{variable}} placeholders\n * @param context - Object containing variable values\n * @returns Parsed string with variables replaced\n */\nexport function parseTemplate(\n  template: string,\n  context: Record<string, any> = {}\n): string {\n  return template.replace(/\\{\\{(\\w+)\\}\\}/g, (match, key) => {\n    return context[key] !== undefined ? String(context[key]) : match\n  })\n}\n\n/**\n * Extract model name from \"provider:model\" format\n * @param modelString - Full model string (e.g., \"openai:gpt-4.1-mini\",\"openai:gpt-4.1-mini:free\")\n * @returns Model name only (e.g., \"gpt-4o-mini\")\n */\nexport function stripModelName(modelString: string): string {\n  const parts = modelString.split(':')\n\n  if (parts.length === 2) {\n    return parts[1] || ''\n  }\n\n  if (parts.length === 3) {\n    return `${parts[1]}:${parts[2]}`\n  }\n\n  return modelString\n}\n\n/**\n * Extract provider name from \"provider:model\" format\n * @param modelString - Full model string (e.g., \"openai:gpt-4.1-mini\")\n * @returns Provider name only (e.g., \"openai\")\n */\nexport function stripProviderName(modelString: string): string {\n  const parts = modelString.split(':')\n  return parts.length > 1 ? (parts[0] ?? '') : ''\n}\n\n/**\n * Check if content contains a specific XML-style tag\n * @param content - Content to check\n * @param tag - Tag name to look for\n * @returns True if tag is found\n */\nexport function hasTag(content: string, tag: string): boolean {\n  const regex = new RegExp(`<${tag}>`, 'i')\n  return regex.test(content)\n}\n\n/**\n * Remove XML-style tags from content\n * @param content - Content with tags\n * @param tag - Tag name to remove\n * @returns Content without the specified tags\n */\nexport function stripTag(content: string, tag: string): string {\n  const openTagRegex = new RegExp(`<${tag}>`, 'gi')\n  const closeTagRegex = new RegExp(`</${tag}>`, 'gi')\n  return content.replace(openTagRegex, '').replace(closeTagRegex, '')\n}\n\n/**\n * Extract content within XML-style tags\n * @param content - Content with tags\n * @param tag - Tag name to extract\n * @returns Content within the tags, or empty string if not found\n */\nexport function extractInnerTag(content: string, tag: string): string {\n  const regex = new RegExp(`<${tag}>(.*?)</${tag}>`, 'is')\n  const match = content.match(regex)\n  return match && match[1] ? match[1].trim() : ''\n}\n\n/**\n * Check if a string is a base64-encoded buffer string (data URL)\n * @param str - String to check\n * @returns True if string is a buffer string\n */\nexport function isBufferString(str: string): boolean {\n  return str.startsWith('data:') && str.includes(';base64,')\n}\n\n/**\n * Detect MIME type from a buffer string (data URL)\n * @param bufferString - Base64 buffer string\n * @returns MIME type (e.g., \"image/png\") or empty string if not detected\n */\nexport function detectMimeTypeFromBufferString(bufferString: string): string {\n  if (!isBufferString(bufferString)) {\n    return ''\n  }\n\n  const match = bufferString.match(/^data:([^;]+);base64,/)\n  return match && match[1] ? match[1] : ''\n}\n\n/**\n * Convert a string to a URL-friendly slug\n * @param text - Text to slugify\n * @returns Slugified text (lowercase, hyphens, alphanumeric)\n */\nexport function slugify(text: string): string {\n  return text\n    .toLowerCase()\n    .trim()\n    .replace(/[^\\w\\s-]/g, '')\n    .replace(/[\\s_-]+/g, '_')\n    .replace(/^-+|-+$/g, '')\n}\n\n/**\n * Get the last n elements from an array\n * @param array - Array to take elements from\n * @param n - Number of elements to take from the end\n * @returns New array with the last n elements\n */\nexport function takeRight<T>(array: T[], n: number = 1): T[] {\n  if (n <= 0) return []\n  if (n >= array.length) return [...array]\n  return array.slice(-n)\n}\n\n/**\n * Remove empty strings from an array\n * @param array - Array of strings to filter\n * @returns New array with empty strings removed\n */\nexport function cleanEmptyList(array: string[]): string[] {\n  return array.filter((item) => item !== '')\n}\n\n/**\n * Log a labeled message with a visual separator\n * @param label - Label to display above the logged content\n * @param args - Arguments to log after the label and separator\n */\nexport function microlog(label: string, ...args: any[]): void {\n  console.log(`\\n${label}`)\n  console.log('='.repeat(50))\n  // console.log(JSON.stringify({ ...args }, null, 2))\n  console.log(...args)\n  console.log('='.repeat(50))\n}\n\n/**\n * Sanitize a provider object by masking sensitive API key information (in logs or CLI)\n * @param provider - Provider object without model property\n * @returns Sanitized provider object with masked API key\n */\nexport function sanitizeProvider(provider: Omit<Provider, 'model'>): any {\n  if (!provider) return provider\n\n  const sanitized = { ...provider }\n\n  if (sanitized.apiKey && typeof sanitized.apiKey === 'string') {\n    const key = sanitized.apiKey\n    // Show first 10 chars, mask the rest except last 8 chars\n    const firstCharacters = 10\n    const lastCharacters = 8\n    const total = firstCharacters + lastCharacters\n\n    if (key.length > total) {\n      const prefix = key.substring(0, firstCharacters)\n      const suffix = key.substring(key.length - lastCharacters)\n      const maskedLength = key.length - total\n      sanitized.apiKey = `${prefix}${''.repeat(maskedLength)}${suffix}`\n    } else if (key.length > firstCharacters) {\n      const prefix = key.substring(0, firstCharacters)\n      sanitized.apiKey = `${prefix}${''.repeat(key.length - firstCharacters)}`\n    } else {\n      sanitized.apiKey = ''.repeat(key.length)\n    }\n  }\n\n  return sanitized\n}\n","import { type z } from 'zod'\nimport { zodToJsonSchema } from 'zod-to-json-schema'\n\nimport type { Tool } from '../types'\n\n/**\n * Creates a tool that can be used by agents to perform specific actions.\n *\n * @param name - The name of the tool\n * @param description - A description of what the tool does\n * @param schema - A zod schema defining the tool's parameters\n * @param executeFn - The function to execute when the tool is called\n * @returns A Tool object with schema and execute function\n *\n * @example\n * ```typescript\n * const weatherTool = createTool(\n *   \"get_weather\",\n *   \"Get the current weather for a location\",\n *   z.object({\n *     location: z.string().describe(\"The city and state, e.g. San Francisco, CA\"),\n *     unit: z.enum([\"celsius\", \"fahrenheit\"]).optional()\n *   }),\n *   async (params) => {\n *     return `Weather in ${params.location}: 72F, sunny`;\n *   }\n * );\n * ```\n */\nexport function createTool<T extends z.ZodTypeAny, R>(\n  name: string,\n  description: string,\n  schema: T,\n  executeFn: (params: z.infer<T>) => Promise<R> | R\n): Tool {\n  const jsonSchema = zodToJsonSchema(schema as any, {\n    target: 'openApi3',\n    $refStrategy: 'none',\n  })\n\n  const properties = (jsonSchema as any).properties || {}\n  const required = (jsonSchema as any).required || []\n\n  return {\n    schema: {\n      type: 'function',\n      function: {\n        name,\n        description,\n        parameters: {\n          type: 'object',\n          properties,\n          required,\n          additionalProperties: false,\n        },\n      },\n    },\n    execute: executeFn,\n  }\n}\n","import dedent from 'dedent'\nimport { z } from 'zod'\nimport { Micro } from './client'\nimport type {\n  MicroOptions,\n  Tool,\n  Message,\n  Metadata,\n  Response,\n  StreamResponse,\n} from './types'\nimport { createTool } from './tools/create-tool'\nimport { cleanEmptyList, slugify } from './utils/utils'\n\nconst SYSTEM_PROMPT_EXTRA = dedent`\nYou should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.\nYou should first think about it, then if necessary, use the tools to get the information you need.\nGo back and forth between the tools and the context until you have a complete understanding of the task.\nDo not repeat the same tool call in consecutive calls.\nNow begin!\n`\n\nexport type AgentOptions = Omit<MicroOptions, 'prompt'> & {\n  name: string\n  background: string\n  goal?: string\n  position?: string\n  additionalInstructions?: string\n  handoffs?: Agent[]\n}\n\nconst AgentDefaults = {\n  model: 'gpt-4o-mini',\n}\n\nexport class Agent {\n  private client: Micro\n  public name: string\n  public background: string\n  public goal: string | undefined\n  public position: string | undefined\n  public handoffs?: Agent[]\n  public tools?: Tool[]\n  public model: string | undefined\n\n  constructor(options: AgentOptions) {\n    this.name = options.name\n    this.background = options.background\n    this.goal = options.goal\n    this.handoffs = options.handoffs || []\n    this.tools = options.tools || []\n    this.position = options.position\n    this.model = options.model\n\n    const context = {\n      role: options.name,\n      background: options.background,\n      goal: options.goal,\n      additionalInstructions: options.additionalInstructions,\n      toolsList: cleanEmptyList([\n        this.handoffAgentToStringList(this.handoffs),\n        this.toolsToStringList(this.tools),\n      ]),\n      ...(options.context || {}),\n    }\n\n    this.client = new Micro({\n      systemPrompt: this.buildSystemPrompt({\n        role: context.role,\n        background: context.background,\n        goal: context.goal,\n        additionalInstructions: context.additionalInstructions,\n        toolsList: context.toolsList || [],\n      }),\n      maxTokens: options.maxTokens,\n      temperature: options.temperature,\n      model: this.model || AgentDefaults.model,\n      debug: !!options.debug,\n      context: context,\n      messages: options.messages,\n      reasoning: options.reasoning,\n      reasoning_effort: options.reasoning_effort,\n      timeout: options.timeout,\n      stream: options.stream,\n      tool_choice: options.tool_choice,\n      onComplete: options.onComplete,\n      onMessage: options.onMessage,\n      onRequest: options.onRequest,\n      onResponseData: options.onResponseData,\n      onError: options.onError,\n      onToolCall: options.onToolCall,\n      ...(this.handoffs && this.handoffs.length > 0\n        ? {\n            tools: [\n              ...(options.tools || []),\n              ...this.handoffAgentToTools(this.handoffs),\n            ],\n          }\n        : { tools: options.tools }),\n    })\n  }\n\n  private buildSystemPrompt(options: {\n    role?: string\n    background?: string\n    goal?: string\n    additionalInstructions?: string\n    toolsList?: string[]\n  }): string {\n    const sections: string[] = []\n\n    if (options?.role) {\n      sections.push(`# ROLE\\nYou are a ${options.role}.`)\n    }\n\n    if (options?.background) {\n      sections.push(`## BACKGROUND\\n${options.background}.`)\n    }\n\n    if (options?.goal) {\n      sections.push(`## MAIN GOAL\\n${options.goal}`)\n    }\n\n    if (options?.additionalInstructions) {\n      sections.push(\n        `## ADDITIONAL INSTRUCTIONS\\n${options.additionalInstructions}`\n      )\n    }\n\n    const toolsText = options?.toolsList?.length\n      ? options.toolsList.join(', ')\n      : '\\n - None provided'\n    sections.push(\n      `## TOOL HINTS\\nYou have access to the following tools: ${toolsText}`\n    )\n\n    sections.push(SYSTEM_PROMPT_EXTRA)\n\n    return sections.join('\\n\\n')\n  }\n\n  private handoffAgentToTools(agents: Agent[]): Tool[] {\n    return agents.map((agent) =>\n      createTool(\n        slugify(agent.name),\n        dedent`You are a ${agent.name}. Use this tool to ${agent.goal ?? agent.background}`,\n        z.object({\n          prompt: z.string().describe('The prompt of the request.'),\n        }),\n        async ({ prompt }) => {\n          const response = await agent.chat(prompt)\n          return response?.completion?.content || response\n        }\n      )\n    )\n  }\n\n  private toolsToStringList(tools: Tool[]): string {\n    if (!tools || tools.length === 0) {\n      return ''\n    }\n    return (\n      '\\n' +\n      tools\n        .map(\n          (tool) =>\n            `- ${tool.schema.function.name} [${slugify(tool.schema.function.name)}]: Its role is to ${\n              tool.schema.function.description\n            }`\n        )\n        .join('\\n')\n    )\n  }\n\n  private handoffAgentToStringList(agents: Agent[]): string {\n    if (!agents || agents.length === 0) {\n      return ''\n    }\n    return (\n      '\\n' +\n      agents\n        .map(\n          (agent) =>\n            `- ${agent.name} [${slugify(agent.name)}]: Its role is to ${\n              agent.background\n            }`\n        )\n        .join('\\n')\n    )\n  }\n\n  public async invoke(): Promise<Response> {\n    return this.client.invoke()\n  }\n\n  public async chat(prompt: string): Promise<Response> {\n    this.addPrompt(prompt)\n    return this.client.invoke()\n  }\n\n  public async stream(prompt: string): Promise<StreamResponse> {\n    this.addPrompt(prompt)\n    return this.client.stream(prompt)\n  }\n\n  public getMessages(): Message[] {\n    return this.client.getMessages()\n  }\n\n  public addPrompt(msg: string): void {\n    this.client.setUserMessage(msg)\n  }\n\n  public addAssistantPrompt(msg: string): void {\n    this.client.setAssistantMessage(msg)\n  }\n\n  public getMetadata(): Metadata {\n    return this.client.getMetadata()\n  }\n\n  public static create(options: AgentOptions): Agent {\n    return new Agent(options)\n  }\n}\n","import { Agent, type AgentOptions } from './agent'\n\nexport class Orchestrator extends Agent {\n  constructor(options: AgentOptions) {\n    super({ ...options, position: 'orchestrator' })\n  }\n\n  public static create(options: AgentOptions): Orchestrator {\n    return new Orchestrator({ ...options, position: 'orchestrator' })\n  }\n}\n","import { spawn, type ChildProcess } from 'child_process'\n\nexport type MCPToolSchema = {\n  name: string\n  description?: string\n  inputSchema: {\n    type: 'object'\n    properties?: Record<string, any>\n    required?: string[]\n  }\n}\n\nexport type MCPServerConfig = {\n  command: string\n  args: string[]\n  env?: Record<string, string>\n}\n\n// MCP request timeout in milliseconds (30 seconds)\nconst MCP_REQUEST_TIMEOUT_MS = 30000\n\n/**\n * MCP Protocol Client\n * Handles communication with MCP servers via stdio\n */\nexport class MCPClient {\n  private process: ChildProcess | null = null\n  private messageId = 0\n  private pendingRequests = new Map<\n    number,\n    { resolve: (value: any) => void; reject: (error: any) => void }\n  >()\n  private buffer = ''\n  private isInitialized = false\n\n  constructor(private config: MCPServerConfig) {}\n\n  /**\n   * Start the MCP server and initialize connection\n   */\n  async connect(): Promise<void> {\n    if (this.process) {\n      return\n    }\n\n    return new Promise((resolve, reject) => {\n      this.process = spawn(this.config.command, this.config.args, {\n        env: { ...process.env, ...this.config.env },\n        stdio: ['pipe', 'pipe', 'pipe'],\n      })\n\n      if (!this.process.stdout || !this.process.stdin) {\n        reject(new Error('Failed to create MCP server process'))\n        return\n      }\n\n      this.process.stdout.on('data', (data: Buffer) => {\n        this.handleData(data)\n      })\n\n      this.process.stderr?.on('data', (data: Buffer) => {\n        console.error('[MCP Server Error]:', data.toString())\n      })\n\n      this.process.on('error', (error) => {\n        reject(error)\n      })\n\n      this.process.on('exit', (code) => {\n        console.log(`[MCP Server] Process exited with code ${code}`)\n        this.cleanup()\n      })\n\n      // Initialize the connection\n      this.sendRequest('initialize', {\n        protocolVersion: '2024-11-05',\n        capabilities: {},\n        clientInfo: {\n          name: 'micro-ai-ts',\n          version: '0.6.4',\n        },\n      })\n        .then(() => {\n          this.isInitialized = true\n          resolve()\n        })\n        .catch(reject)\n    })\n  }\n\n  /**\n   * Handle incoming data from MCP server\n   */\n  private handleData(data: Buffer): void {\n    this.buffer += data.toString()\n\n    // Process complete JSON-RPC messages\n    const lines = this.buffer.split('\\n')\n    this.buffer = lines.pop() || ''\n\n    for (const line of lines) {\n      if (!line.trim()) continue\n\n      try {\n        const message = JSON.parse(line)\n        this.handleMessage(message)\n      } catch (error) {\n        console.error('[MCP Client] Failed to parse message:', line, error)\n      }\n    }\n  }\n\n  /**\n   * Handle a parsed JSON-RPC message\n   */\n  private handleMessage(message: any): void {\n    if (message.id !== undefined) {\n      const pending = this.pendingRequests.get(message.id)\n      if (pending) {\n        this.pendingRequests.delete(message.id)\n        if (message.error) {\n          pending.reject(new Error(message.error.message || 'MCP Error'))\n        } else {\n          pending.resolve(message.result)\n        }\n      }\n    }\n  }\n\n  /**\n   * Send a JSON-RPC request to the MCP server\n   */\n  private sendRequest(method: string, params?: any): Promise<any> {\n    return new Promise((resolve, reject) => {\n      if (!this.process?.stdin) {\n        reject(new Error('MCP server not connected'))\n        return\n      }\n\n      const id = ++this.messageId\n      const request = {\n        jsonrpc: '2.0',\n        id,\n        method,\n        params,\n      }\n\n      this.pendingRequests.set(id, { resolve, reject })\n\n      try {\n        this.process.stdin.write(JSON.stringify(request) + '\\n')\n      } catch (error) {\n        this.pendingRequests.delete(id)\n        reject(error)\n      }\n\n      // Timeout after configured duration\n      setTimeout(() => {\n        if (this.pendingRequests.has(id)) {\n          this.pendingRequests.delete(id)\n          reject(new Error(`Request timeout: ${method}`))\n        }\n      }, MCP_REQUEST_TIMEOUT_MS)\n    })\n  }\n\n  /**\n   * List all available tools from the MCP server\n   */\n  async listTools(): Promise<MCPToolSchema[]> {\n    if (!this.isInitialized) {\n      await this.connect()\n    }\n\n    const response = await this.sendRequest('tools/list')\n    return response.tools || []\n  }\n\n  /**\n   * Call a tool on the MCP server\n   */\n  async callTool(name: string, args: any): Promise<any> {\n    if (!this.isInitialized) {\n      await this.connect()\n    }\n\n    const response = await this.sendRequest('tools/call', {\n      name,\n      arguments: args,\n    })\n\n    // Extract content from MCP response\n    if (response.content && Array.isArray(response.content)) {\n      // Combine all text content\n      return response.content\n        .filter((item: any) => item.type === 'text')\n        .map((item: any) => item.text)\n        .join('\\n')\n    }\n\n    return response\n  }\n\n  /**\n   * Close the connection and cleanup\n   */\n  async disconnect(): Promise<void> {\n    if (this.process) {\n      this.process.kill()\n      this.cleanup()\n    }\n  }\n\n  private cleanup(): void {\n    this.process = null\n    this.isInitialized = false\n    this.pendingRequests.clear()\n    this.buffer = ''\n  }\n}\n","import { z } from 'zod'\nimport { createTool } from './create-tool'\nimport {\n  MCPClient,\n  type MCPServerConfig,\n  type MCPToolSchema,\n} from './mcp-client'\nimport type { Tool } from '../types'\n\n/**\n * Convert MCP JSON Schema to Zod schema\n */\nfunction jsonSchemaToZod(schema: any): z.ZodTypeAny {\n  if (!schema || typeof schema !== 'object') {\n    return z.any()\n  }\n\n  const type = schema.type\n\n  switch (type) {\n    case 'string':\n      return z.string()\n    case 'number':\n      return z.number()\n    case 'integer':\n      return z.number().int()\n    case 'boolean':\n      return z.boolean()\n    case 'array':\n      if (schema.items) {\n        return z.array(jsonSchemaToZod(schema.items))\n      }\n      return z.array(z.any())\n    case 'object':\n      if (schema.properties) {\n        const shape: Record<string, z.ZodTypeAny> = {}\n        for (const [key, value] of Object.entries(schema.properties)) {\n          let fieldSchema = jsonSchemaToZod(value)\n\n          // Make optional if not in required array\n          if (!schema.required?.includes(key)) {\n            fieldSchema = fieldSchema.optional()\n          }\n\n          shape[key] = fieldSchema\n        }\n        return z.object(shape)\n      }\n      return z.record(z.any())\n    default:\n      return z.any()\n  }\n}\n\n// Store active MCP clients for cleanup\nconst activeMCPClients: MCPClient[] = []\n\n// Cleanup function\nconst cleanupMCPClients = async () => {\n  const clients = [...activeMCPClients]\n  activeMCPClients.length = 0\n\n  for (const client of clients) {\n    try {\n      await client.disconnect()\n    } catch {\n      // Ignore cleanup errors\n    }\n  }\n}\n\n// Register cleanup handlers\nif (typeof process !== 'undefined') {\n  process.on('beforeExit', () => {\n    cleanupMCPClients()\n  })\n\n  process.on('SIGINT', () => {\n    cleanupMCPClients().then(() => process.exit(0))\n  })\n\n  process.on('SIGTERM', () => {\n    cleanupMCPClients().then(() => process.exit(0))\n  })\n}\n\n/**\n * Manually disconnect all active MCP clients\n * Useful for cleaning up in long-running applications\n *\n * @example\n * ```typescript\n * const tools = await createMCPTools({ ... })\n * // ... use tools ...\n * await disconnectAllMCPClients() // Clean up when done\n * ```\n */\nexport async function disconnectAllMCPClients(): Promise<void> {\n  await cleanupMCPClients()\n}\n\n/**\n * Create Micro AI tools from an MCP server\n *\n * @param config - MCP server configuration\n * @param toolNames - Optional array of specific tool names to load (loads all if not specified)\n * @returns Promise resolving to array of Tool objects\n *\n * @example\n * ```typescript\n * // Load all tools from an MCP server\n * const tools = await createMCPTools({\n *   command: 'uvx',\n *   args: ['mcp-server-fetch']\n * })\n *\n * // Load specific tools only\n * const tools = await createMCPTools(\n *   { command: 'uvx', args: ['mcp-server-fetch'] },\n *   ['fetch']\n * )\n *\n * // Use with Micro client\n * const client = new Micro({\n *   model: 'openai:gpt-4.1-mini',\n *   tools\n * })\n * ```\n */\nexport async function createMCPTools(\n  config: MCPServerConfig,\n  toolNames?: string[]\n): Promise<Tool[]> {\n  const client = new MCPClient(config)\n\n  try {\n    await client.connect()\n    const mcpTools = await client.listTools()\n\n    // Filter tools if specific names provided\n    const toolsToCreate = toolNames\n      ? mcpTools.filter((tool) => toolNames.includes(tool.name))\n      : mcpTools\n\n    if (toolsToCreate.length === 0) {\n      console.warn('[MCP] No tools found matching criteria')\n      return []\n    }\n\n    // Convert each MCP tool to a Micro AI tool\n    const tools = toolsToCreate.map((mcpTool: MCPToolSchema) => {\n      const zodSchema = jsonSchemaToZod(mcpTool.inputSchema)\n\n      return createTool(\n        mcpTool.name,\n        mcpTool.description || `MCP tool: ${mcpTool.name}`,\n        zodSchema,\n        async (args: any) => {\n          try {\n            const result = await client.callTool(mcpTool.name, args)\n            return result\n          } catch (error: any) {\n            throw new Error(`MCP tool error: ${error.message}`)\n          }\n        }\n      )\n    })\n\n    // Track client for cleanup\n    activeMCPClients.push(client)\n\n    return tools\n  } catch (error: any) {\n    await client.disconnect()\n    throw new Error(`Failed to create MCP tools: ${error.message}`)\n  }\n}\n\n/**\n * Create a single MCP tool\n *\n * @param config - MCP server configuration\n * @param toolName - Name of the specific tool to load\n * @returns Promise resolving to a Tool object\n *\n * @example\n * ```typescript\n * const fetchTool = await createMCPTool(\n *   { command: 'uvx', args: ['mcp-server-fetch'] },\n *   'fetch'\n * )\n * ```\n */\nexport async function createMCPTool(\n  config: MCPServerConfig,\n  toolName: string\n): Promise<Tool> {\n  const tools = await createMCPTools(config, [toolName])\n\n  if (tools.length === 0) {\n    throw new Error(`MCP tool \"${toolName}\" not found`)\n  }\n\n  return tools[0]!\n}\n"]}