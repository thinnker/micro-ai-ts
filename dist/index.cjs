'use strict';require('dotenv/config');var z=require('hyperid'),G=require('dedent'),zod=require('zod'),zodToJsonSchema=require('zod-to-json-schema');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var z__default=/*#__PURE__*/_interopDefault(z);var G__default=/*#__PURE__*/_interopDefault(G);var B=Object.defineProperty;var Y=(s,e)=>{for(var t in e)B(s,t,{get:e[t],enumerable:true});};function j(s){let{model:e,...t}=s;return {provider:t,model:e}}var R={openai:(s="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:s}),groq:(s="llama-3.3-70b-versatile")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:s}),gemini:(s="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:s}),ai302:(s="gpt-4o-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:s}),openrouter:(s="anthropic/claude-haiku-4.5")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:s}),deepseek:(s="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:s}),grok:(s="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:s})};var w={};Y(w,{del:()=>k,get:()=>_,head:()=>I,httpClient:()=>f,options:()=>S,patch:()=>L,post:()=>A,put:()=>C});var Q=["POST","post","PUT","put","PATCH","patch"];async function m(s){let{baseURL:e,endpoint:t,headers:o,body:i,timeout:n,method:a="POST"}=s,c=new AbortController,r=n?setTimeout(()=>c.abort(),n):void 0;try{let l={method:a,headers:o,signal:c.signal};i&&Q.includes(a)&&(l.body=JSON.stringify(i));let p=await fetch(`${e}${t}`,l);if(r&&clearTimeout(r),!p.ok){let E=await p.json().catch(()=>({})),T=new Error(E.error?.message||`HTTP error! status: ${p.status}`);throw T.response={status:p.status,data:E},T.code="HTTP_ERROR",T}return await p.json()}catch(l){if(r&&clearTimeout(r),l.name==="AbortError"){let p=new Error("Request timeout");throw p.code="ECONNABORTED",p}throw l}}async function f(s){return m(s)}async function _(s){return m({...s,method:"GET"})}async function A(s){return m({...s,method:"POST"})}async function C(s){return m({...s,method:"PUT"})}async function L(s){return m({...s,method:"PATCH"})}async function k(s){return m({...s,method:"DELETE"})}async function I(s){return m({...s,method:"HEAD"})}async function S(s){return m({...s,method:"OPTIONS"})}function b(){return z__default.default({urlSafe:true})()}function g(s,e={}){return s.replace(/\{\{(\w+)\}\}/g,(t,o)=>e[o]!==void 0?String(e[o]):t)}function N(s){let e=s.split(":");return e.length>1?e[1]??s:s}function D(s){let e=s.split(":");return e.length>1?e[0]??"":""}function P(s,e){return new RegExp(`<${e}>`,"i").test(s)}function M(s,e){let t=new RegExp(`<${e}>`,"gi"),o=new RegExp(`</${e}>`,"gi");return s.replace(t,"").replace(o,"")}function O(s,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),o=s.match(t);return o&&o[1]?o[1].trim():""}function U(s){return s.startsWith("data:")&&s.includes(";base64,")}function d(s){return s.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function K(s,e=1){return e<=0?[]:e>=s.length?[...s]:s.slice(-e)}function $(s){return s.filter(e=>e!=="")}function H(s){if(!s)return s;let e={...s};if(e.apiKey&&typeof e.apiKey=="string"){let t=e.apiKey,o=10,i=8,n=o+i;if(t.length>n){let a=t.substring(0,o),c=t.substring(t.length-i),r=t.length-n;e.apiKey=`${a}${"\u2022".repeat(r)}${c}`;}else if(t.length>o){let a=t.substring(0,o);e.apiKey=`${a}${"\u2022".repeat(t.length-o)}`;}else e.apiKey="\u2022".repeat(t.length);}return e}var h={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4o-mini",temperature:0,defaultEndpointCompletionSuffix:"/chat/completions"},u=class{baseURL;headers;model;systemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;streaming;parsedSystemPrompt;defaultProvider;modelName;providerName;identifier;timeout;reasoning_effort;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;debug;reasoning;isReasoningModel;isGemini25Reasoning;isOpenAIReasoning;isOpenAI5;isGLMReasoning;isQWQ;isDeepseekReasoning;isQwen3;constructor(e={}){this.identifier=b(),this.timeout=e?.timeout,this.modelName=N(e?.model||"")||h.model,this.providerName=D(e?.model||"")||h.providerName;let t;if(this.providerName){let o=R[this.providerName];o&&(t=o(this.modelName));}if(this.defaultProvider={baseURL:t?.baseURL??e?.provider?.baseURL??h.baseURL,apiKey:t?.apiKey??e?.provider?.apiKey??h.apiKey,...e?.provider?.headers&&{headers:e.provider.headers}},!this.defaultProvider.apiKey)throw new Error("API Key is required");this.baseURL=this.defaultProvider.baseURL,this.headers={Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers},this.model=this.modelName,this.systemPrompt=e?.systemPrompt||"",this.prompt=e?.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?g(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature!==void 0?e.temperature:h.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.debug=e?.debug||false,this.streaming=e?.streaming||false,this.reasoning=e?.reasoning??true,this.reasoning_effort=e.reasoning_effort??"medium",this.isOpenAI5=this.model?.toLowerCase()?.includes("gpt-5"),this.isOpenAIReasoning=this.model?.toLowerCase()?.includes("o1")||this.model?.toLowerCase()?.includes("o3")||this.model?.toLowerCase()?.includes("o4")||this.isOpenAI5,this.isGemini25Reasoning=this.model?.toLowerCase()?.includes("gemini-2.5"),this.isGLMReasoning=this.model?.toLowerCase()?.includes("glm-4."),this.isQWQ=this.model?.toLowerCase()?.includes("qwq"),this.isDeepseekReasoning=this.model?.toLowerCase()?.includes("deepseek-reasoner")||this.model?.toLowerCase()?.includes("deepseek-r1"),this.isQwen3=this.model?.toLowerCase()?.includes("qwen3"),this.isReasoningModel=this.isGemini25Reasoning||this.isOpenAIReasoning||this.isGLMReasoning||this.isQWQ||this.isDeepseekReasoning||this.isQwen3,this.onComplete=e.onComplete||void 0,this.onMessage=e.onMessage||void 0,this.onRequest=e.onRequest||void 0,this.onResponseData=e.onResponseData||void 0,this.onError=e.onError||void 0,this.onToolCall=e.onToolCall||void 0,this.messages=e?.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&(console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",H(this.defaultProvider)),console.log(`=============================================
`));}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){e&&(this.parsedSystemPrompt=g(e,this.context),this.parsedSystemPrompt&&!this.getSystemMessage().length&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt}));}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),o=this.getNonSystemMessages(),i=K(o,e),n=[...t,...i];return this.messages=n,this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let o=g(e,this.context);this.prompt=o,t&&U(t)?this.messages.push({role:"user",content:[{type:"text",text:o},{type:"image_url",image_url:{url:t}}]}):this.messages.push({role:"user",content:o}),this.onMessage&&this.onMessage(this.messages);}setAssistantMessage(e){let t=g(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage&&this.onMessage(this.messages),this}async makeRequest(){let e={model:this.model,messages:this.messages,stream:this.streaming};if(this.temperature&&(e.temperature=this.temperature),this.maxTokens&&(e.max_tokens=this.maxTokens),this.tools&&this.tools.length>0&&(e.tools=this.tools.map(o=>o.schema),this.tool_choice&&(e.tool_choice=this.tool_choice)),this.reasoning&&this.isReasoningModel)if(this.isOpenAIReasoning)e.reasoning_effort=this.reasoning_effort,this.maxTokens&&(e.max_completion_tokens=this.maxTokens,delete e.max_tokens);else if(this.isGemini25Reasoning){let o={minimal:2048,low:4096,medium:8192,high:16384};e.extra_body={google:{thinking_config:{thinking_budget:o[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.isGLMReasoning&&(e.thinking={type:"enabled"});this.onRequest&&this.onRequest(e);let t=await f({baseURL:this.baseURL,endpoint:h.defaultEndpointCompletionSuffix,headers:this.headers,body:e,timeout:this.timeout,method:"POST"});return this.onResponseData&&this.onResponseData(t),t}async executeTool(e,t){let o=this.tools?.find(i=>i.schema.function.name===e);if(!o){let i=`Tool "${e}" not found`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:i}),i}try{let i=JSON.parse(t),n=await o.execute(i);return this.onToolCall&&this.onToolCall({toolName:e,arguments:i,result:n}),n}catch(i){let n=`Error executing tool "${e}": ${i.message}`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:n}),n}}async handleToolCalls(e){for(let t of e){let o=t.function.name,i=t.function.arguments,n=await this.executeTool(o,i);this.messages.push({role:"tool",tool_call_id:t.id,name:o,content:typeof n=="string"?n:JSON.stringify(n)}),this.onMessage&&this.onMessage(this.messages);}}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),i=t.choices?.[0]?.message;if(i&&(this.messages.push(i),this.onMessage&&this.onMessage(this.messages)),i?.tool_calls&&i.tool_calls.length>0)return await this.handleToolCalls(i.tool_calls),this.invoke();let a=Date.now()-e,c="",r=i?.content||"",l=!1;this.reasoning&&this.isReasoningModel&&r&&(P(r,"thinking")?(c=O(r,"thinking"),r=M(r,"thinking"),l=!0):P(r,"think")&&(c=O(r,"think"),r=M(r,"think"),l=!0));let p={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t.usage,timing:{latencyMs:a,latencySeconds:a/1e3},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:l}},fullResponse:t,completion:{role:i?.role||"assistant",content:r.trim(),reasoning:c.trim(),original:i?.content||""}};return this.onComplete&&this.onComplete(p,this.messages),p}catch(t){let n={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:t.code==="ECONNABORTED"?"timeout":"api_error",message:t.message,status:t.response?.status,code:t.code,details:t.response?.data}};return this.onError&&this.onError(n.error),Promise.reject(n.error)}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}};function y(s,e,t,o){let i=zodToJsonSchema.zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),n=i.properties||{},a=i.required||[];return {schema:{type:"function",function:{name:s,description:e,parameters:{type:"object",properties:n,required:a,additionalProperties:false}}},execute:o}}var W=G__default.default`
You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first think about it, then if necessary, use the tools to get the information you need.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin!
`,J={model:"gpt-4o-mini"},v=class s{client;name;background;goal;position;handoffs;tools;model;constructor(e){this.name=e.name,this.background=e.background,this.goal=e.goal,this.handoffs=e.handoffs||[],this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.background,goal:e.goal,additionalInstructions:e.additionalInstructions,toolsList:$([this.handoffAgentToStringList(this.handoffs),this.toolsToStringList(this.tools)]),...e.context||{}};this.client=new u({systemPrompt:this.buildSystemPrompt({role:t.role,background:t.background,goal:t.goal,additionalInstructions:t.additionalInstructions,toolsList:t.toolsList||[]}),maxTokens:e.maxTokens||4e3,temperature:e.temperature??0,model:this.model||J.model,debug:e.debug||false,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,streaming:e.streaming,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}buildSystemPrompt(e){let t=[];e?.role&&t.push(`# ROLE
You are a ${e.role}.`),e?.background&&t.push(`## BACKGROUND
${e.background}.`),e?.goal&&t.push(`## MAIN GOAL
${e.goal}`),e?.additionalInstructions&&t.push(`## ADDITIONAL INSTRUCTIONS
${e.additionalInstructions}`);let o=e?.toolsList?.length?e.toolsList.join(", "):`
 - None provided`;return t.push(`## TOOL HINTS
You have access to the following tools: ${o}`),t.push(W),t.join(`

`)}handoffAgentToTools(e){return e.map(t=>y(d(t.name),G__default.default`You are a ${t.name}. Use this tool to ${t.goal??t.background}`,zod.z.object({prompt:zod.z.string().describe("The prompt of the request.")}),async({prompt:o})=>{let i=await t.chat(o);return i?.completion?.content||i}))}toolsToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.schema.function.name} [${d(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.name} [${d(t.name)}]: Its role is to ${t.background}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new s(e)}},x=class s extends v{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new s({...e,position:"orchestrator"})}};Object.defineProperty(exports,"z",{enumerable:true,get:function(){return zod.z}});exports.Agent=v;exports.Micro=u;exports.Orchestrator=x;exports.Providers=R;exports.createProvider=j;exports.createTool=y;exports.del=k;exports.get=_;exports.head=I;exports.http=w;exports.httpClient=f;exports.options=S;exports.parseTemplate=g;exports.patch=L;exports.post=A;exports.put=C;exports.randomId=b;exports.slugify=d;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map