'use strict';require('dotenv/config');var oe=require('dedent'),zod=require('zod'),zodToJsonSchema=require('zod-to-json-schema'),child_process=require('child_process');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var oe__default=/*#__PURE__*/_interopDefault(oe);var pe=Object.defineProperty;var de=(o,e)=>{for(var t in e)pe(o,t,{get:e[t],enumerable:true});};function me(o){let{model:e,...t}=o;return {provider:t,model:e}}var A={openai:(o="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:o}),groq:(o="llama-3.3-70b-versatile")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:o}),gemini:(o="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:o}),ai302:(o="gpt-4.1-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:o}),openrouter:(o="openai/gpt-4.1-mini")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:o}),deepseek:(o="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:o}),grok:(o="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:o}),fireworks:(o="accounts/fireworks/models/llama4-maverick-instruct-basic")=>({apiKey:process.env.FIREWORKS_API_KEY||"",baseURL:process.env.FIREWORKS_BASE_URL||"https://api.fireworks.ai/inference/v1",model:o}),mistral:(o="mistral-large-latest")=>({apiKey:process.env.MISTRAL_API_KEY||"",baseURL:process.env.MISTRAL_BASE_URL||"https://api.mistral.ai/v1",model:o}),together:(o="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo")=>({apiKey:process.env.TOGETHER_API_KEY||"",baseURL:process.env.TOGETHER_BASE_URL||"https://api.together.xyz/v1",model:o}),nscale:(o="meta-llama/Llama-3.1-8B-Instruct")=>({apiKey:process.env.NSCALE_API_KEY||"",baseURL:process.env.NSCALE_BASE_URL||"https://inference.api.nscale.com/v1",model:o}),minimax:(o="MiniMax-M2")=>({apiKey:process.env.MINIMAX_API_KEY||"",baseURL:process.env.MINIMAX_BASE_URL||"https://api.minimax.io/v1",model:o})};var W={};de(W,{del:()=>j,get:()=>B,head:()=>F,httpClient:()=>S,options:()=>J,patch:()=>G,post:()=>z,put:()=>Y});var ge=["POST","post","PUT","put","PATCH","patch"];async function f(o){let{baseURL:e,endpoint:t,headers:s,body:n,timeout:r,method:i="POST",stream:a=false}=o,p=new AbortController,d=r?setTimeout(()=>p.abort(),r):void 0;try{let c={method:i,headers:s,signal:p.signal};n&&ge.includes(i)&&(c.body=JSON.stringify(n));let l=await fetch(`${e}${t}`,c);if(d&&clearTimeout(d),!l.ok){let y=await l.json().catch(()=>({})),u=new Error(y.error?.message||`HTTP error! status: ${l.status}`);throw u.response={status:l.status,data:y},u.code="HTTP_ERROR",u}return a?l:await l.json()}catch(c){if(d&&clearTimeout(d),c.name==="AbortError"){let l=new Error("Request timeout");throw l.code="ECONNABORTED",l}throw c}}async function S(o){return f(o)}async function B(o){return f({...o,method:"GET"})}async function z(o){return f({...o,method:"POST"})}async function Y(o){return f({...o,method:"PUT"})}async function G(o){return f({...o,method:"PATCH"})}async function j(o){return f({...o,method:"DELETE"})}async function F(o){return f({...o,method:"HEAD"})}async function J(o){return f({...o,method:"OPTIONS"})}function I(){return crypto.randomUUID()}function v(o,e={}){return o.replace(/\{\{(\w+)\}\}/g,(t,s)=>e[s]!==void 0?String(e[s]):t)}function Q(o){let e=o.split(":");return e.length===2?e[1]||"":e.length===3?`${e[1]}:${e[2]}`:o}function Z(o){let e=o.split(":");return e.length>1?e[0]??"":""}function L(o,e){return new RegExp(`<${e}>`,"i").test(o)}function k(o,e){let t=new RegExp(`<${e}>`,"gi"),s=new RegExp(`</${e}>`,"gi");return o.replace(t,"").replace(s,"")}function N(o,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),s=o.match(t);return s&&s[1]?s[1].trim():""}function V(o){return o.startsWith("data:")&&o.includes(";base64,")}function b(o){return o.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"_").replace(/^-+|-+$/g,"")}function X(o,e=1){return e<=0?[]:e>=o.length?[...o]:o.slice(-e)}function ee(o){return o.filter(e=>e!=="")}function te(o){if(!o)return o;let e={...o};if(e.apiKey&&typeof e.apiKey=="string"){let t=e.apiKey,s=10,n=8,r=s+n;if(t.length>r){let i=t.substring(0,s),a=t.substring(t.length-n),p=t.length-r;e.apiKey=`${i}${"\u2022".repeat(p)}${a}`;}else if(t.length>s){let i=t.substring(0,s);e.apiKey=`${i}${"\u2022".repeat(t.length-s)}`;}else e.apiKey="\u2022".repeat(t.length);}return e}var M={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4.1-mini",defaultEndpointCompletionSuffix:"/chat/completions"},x=class{identifier;baseURL;headers;model;modelName;providerName;defaultProvider;capabilities;debug;streamEnabled;timeout;systemPrompt;parsedSystemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;reasoning;reasoning_effort;override;maxToolInterations;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;constructor(e={}){this.identifier=I(),this.timeout=e.timeout??12e4,this.debug=e.debug??false,this.maxToolInterations=e.maxToolInterations??10,this.streamEnabled=e.stream??false,this.modelName=Q(e.model||"")||M.model,this.providerName=Z(e.model||"")||M.providerName,this.model=this.modelName,this.defaultProvider=this.initializeProvider(e),this.baseURL=this.defaultProvider.baseURL,this.headers=this.buildHeaders(),this.capabilities=this.detectModelCapabilities(),this.reasoning=e.reasoning??this.capabilities.isReasoningModel,this.reasoning_effort=this.reasoning?e.reasoning_effort??"medium":void 0,this.systemPrompt=e.systemPrompt||"",this.prompt=e.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?v(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.override=e.override,this.onComplete=e.onComplete,this.onMessage=e.onMessage,this.onRequest=e.onRequest,this.onResponseData=e.onResponseData,this.onError=e.onError,this.onToolCall=e.onToolCall,this.messages=e.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&this.logDebugInfo();}initializeProvider(e){let t=A[this.providerName],s=t?.(this.modelName),n={baseURL:s?.baseURL??e.provider?.baseURL??M.baseURL,apiKey:s?.apiKey??e.provider?.apiKey??M.apiKey,...e.provider?.headers&&{headers:e.provider.headers}};if(!n.apiKey)throw new Error("API Key is required");return n}buildHeaders(){return {Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers}}detectModelCapabilities(){let e=this.model.toLowerCase(),t=e.includes("gpt-5"),s=["o1","o3","o4"].some(l=>e.includes(l))||t,n=e.includes("gemini-2.5"),r=e.includes("glm-4."),i=e.includes("qwq"),a=e.includes("deepseek-reasoner")||e.includes("deepseek-r1"),p=e.includes("qwen3"),d=e.includes("-m2");return {isOpenAI5:t,isOpenAIReasoning:s,isGemini25Reasoning:n,isGLMReasoning:r,isQWQ:i,isDeepseekReasoning:a,isQwen3:p,isMinimaxM2:d,isReasoningModel:n||s||r||i||a||p||d}}logDebugInfo(){console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",te(this.defaultProvider)),console.log(`=============================================
`);}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.capabilities.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel,...this.reasoning_effort&&{reasoning_effort:this.reasoning_effort}}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){if(!e)return;this.parsedSystemPrompt=v(e,this.context);let t=this.messages.some(s=>s.role==="system");this.parsedSystemPrompt&&!t&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt});}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),s=this.getNonSystemMessages(),n=X(s,e);return this.messages=[...t,...n],this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let s=v(e,this.context);this.prompt=s;let n=t&&V(t)?[{type:"text",text:s},{type:"image_url",image_url:{url:t}}]:s;this.messages.push({role:"user",content:n}),this.onMessage?.(this.messages);}setAssistantMessage(e){let t=v(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage?.(this.messages),this}buildRequestBody(e){let t={model:this.model,messages:this.messages,stream:e||this.streamEnabled};return this.temperature!==void 0&&(t.temperature=this.temperature),this.maxTokens&&(t.max_tokens=this.maxTokens),this.tools?.length&&(t.tools=this.tools.map(s=>s.schema),this.tool_choice&&(t.tool_choice=this.tool_choice)),this.reasoning&&this.capabilities.isReasoningModel&&this.applyReasoningConfig(t),this.override&&(t={...t,...this.override}),t}applyReasoningConfig(e){if(this.capabilities.isOpenAIReasoning)e.reasoning_effort=this.reasoning_effort,this.maxTokens&&(e.max_completion_tokens=this.maxTokens,delete e.max_tokens);else if(this.capabilities.isGemini25Reasoning){let t={minimal:2048,low:4096,medium:8192,high:16384};e.extra_body={google:{thinking_config:{thinking_budget:t[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.capabilities.isGLMReasoning&&(e.thinking={type:"enabled"});}async makeRequest(e=false){let t=this.buildRequestBody(e);this.onRequest?.(t);let s=await S({baseURL:this.baseURL,endpoint:M.defaultEndpointCompletionSuffix,headers:this.headers,body:t,timeout:this.timeout,method:"POST",stream:e||this.streamEnabled});return e||this.onResponseData?.(s),s}async executeTool(e,t){let s=this.tools?.find(n=>n.schema.function.name===e);if(!s){let n=`Tool "${e}" not found`;return this.onToolCall?.({toolName:e,arguments:t,result:null,error:n}),n}try{let n=JSON.parse(t),r=await s.execute(n);return this.onToolCall?.({toolName:e,arguments:n,result:r}),r}catch(n){let r=`Error executing tool "${e}": ${n.message}`;return this.onToolCall?.({toolName:e,arguments:t,result:null,error:r}),r}}async handleToolCalls(e){let t=e.map(async n=>{let r=await this.executeTool(n.function.name,n.function.arguments);return {role:"tool",tool_call_id:n.id,name:n.function.name,content:typeof r=="string"?r:JSON.stringify(r)}}),s=await Promise.all(t);this.messages.push(...s),this.onMessage?.(this.messages);}extractReasoning(e){let t=e?.reasoning||e?.reasoning_content||"",s=e?.content||"";return L(s,"thinking")?(t=N(s,"thinking"),s=k(s,"thinking")):L(s,"thought")&&(t=N(s,"thought"),s=k(s,"thought")),{reasoning:t,content:s}}buildResponse(e,t,s,n,r){return {metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:e.usage,timing:{latencyMs:t,latencySeconds:t/1e3},timestamp:new Date().toISOString(),context:this.context,isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel||s.length>0,...this.reasoning_effort&&{reasoning_effort:this.reasoning_effort},hasThoughts:s.length>0},fullResponse:e,completion:{role:r?.role||"assistant",content:n.trim(),reasoning:s.trim(),original:r?.content||""}}}buildErrorResponse(e,t){return {metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:t,latencySeconds:t/1e3},timestamp:new Date().toISOString(),context:this.context},completion:{role:"assistant",content:"",original:""},error:{type:e.code==="ECONNABORTED"?"timeout":"api_error",message:e.message,status:e.response?.status,code:e.code,details:e.response?.data}}}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),s=t.choices?.[0]?.message;if(s&&(this.messages.push(s),this.onMessage?.(this.messages)),s?.tool_calls?.length)return await this.handleToolCalls(s.tool_calls),this.invoke();let n=Date.now()-e,{reasoning:r,content:i}=this.extractReasoning(s),a=this.buildResponse(t,n,r,i,s);return this.onComplete?.(a,this.messages),a}catch(t){let s=Date.now()-e,n=this.buildErrorResponse(t,s);return this.onError?.(n.error),Promise.reject(n.error)}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}buildStreamMetadata(e,t,s){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t,timing:{latencyMs:e,latencySeconds:e/1e3},timestamp:new Date().toISOString(),context:this.context,isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel,...this.reasoning_effort&&{reasoning_effort:this.reasoning_effort},hasThoughts:s.length>0}}async*processStream(e,t){let s=e.body?.getReader();if(!s)throw new Error("Stream not available");let n=new TextDecoder,r="",i="",a="assistant",p="",d,c=[];try{for(;;){let{done:ae,value:le}=await s.read();if(ae)break;p+=n.decode(le,{stream:!0});let H=p.split(`
`);p=H.pop()||"";for(let ce of H){let C=ce.trim();if(!(!C||C==="data: [DONE]")&&C.startsWith("data: "))try{let _=JSON.parse(C.slice(6)),g=_.choices?.[0]?.delta;if(this.debug&&g&&console.log("STREAM: Received delta:",JSON.stringify(g,null,2)),g?.role&&(a=g.role),g?.tool_calls)for(let h of g.tool_calls){let P=h.index??c.length;c[P]?(h.id&&(c[P].id=h.id),h.function?.name&&(c[P].function.name=h.function.name),h.function?.arguments&&(c[P].function.arguments+=h.function.arguments)):c[P]={id:h.id||"",type:"function",function:{name:h.function?.name||"",arguments:h.function?.arguments||""}};}let w=g?.reasoning||g?.reasoning_content;(g?.content||w)&&(r+=g.content||"",i+=w||"",yield {delta:g.content,reasoning:w,fullContent:r,done:!1}),_.usage&&(d=_.usage);}catch{}}}let l={role:a,content:r};c.length>0&&(l.tool_calls=c),this.messages.push(l),this.onMessage?.(this.messages);let y=Date.now()-t,u=this.buildStreamMetadata(y,d,i),$={role:a,content:r.trim(),reasoning:i.trim(),original:r},ie={metadata:u,completion:$};this.onComplete?.(ie,this.messages),yield {delta:"",fullContent:r.trim(),reasoning:i.trim(),done:!0,metadata:u,completion:$};}catch(l){let y=Date.now()-t,u=this.buildErrorResponse(l,y);throw this.onError?.(u.error),u.error}}async stream(e,t){return this.setUserMessage(e,t),this.streamWithToolHandling()}async*streamWithToolHandling(){let e=0;for(;e<this.maxToolInterations;){e++;let t=Date.now();try{let s=await this.makeRequest(!0),n=this.processStream(s,t),r=!1;for await(let i of n)i.done?this.messages[this.messages.length-1]?.tool_calls?.length?r=!0:yield i:yield i;if(r){let i=this.messages[this.messages.length-1];i?.tool_calls&&await this.handleToolCalls(i.tool_calls);continue}break}catch(s){let n=Date.now()-t,r=this.buildErrorResponse(s,n);throw this.onError?.(r.error),r.error}}if(e>=this.maxToolInterations)throw new Error("Max tool call iterations reached")}};function R(o,e,t,s){let n=zodToJsonSchema.zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),r=n.properties||{},i=n.required||[];return {schema:{type:"function",function:{name:o,description:e,parameters:{type:"object",properties:r,required:i,additionalProperties:false}}},execute:s}}var ue=oe__default.default`
You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first think about it, then if necessary, use the tools to get the information you need.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin!
`,fe={model:"gpt-4o-mini"},E=class o{client;name;background;goal;position;handoffs;tools;model;constructor(e){this.name=e.name,this.background=e.background,this.goal=e.goal,this.handoffs=e.handoffs||[],this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.background,goal:e.goal,additionalInstructions:e.additionalInstructions,toolsList:ee([this.handoffAgentToStringList(this.handoffs),this.toolsToStringList(this.tools)]),...e.context||{}};this.client=new x({systemPrompt:this.buildSystemPrompt({role:t.role,background:t.background,goal:t.goal,additionalInstructions:t.additionalInstructions,toolsList:t.toolsList||[]}),maxTokens:e.maxTokens,temperature:e.temperature,model:this.model||fe.model,debug:!!e.debug,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,stream:e.stream,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}buildSystemPrompt(e){let t=[];e?.role&&t.push(`# ROLE
You are a ${e.role}.`),e?.background&&t.push(`## BACKGROUND
${e.background}.`),e?.goal&&t.push(`## MAIN GOAL
${e.goal}`),e?.additionalInstructions&&t.push(`## ADDITIONAL INSTRUCTIONS
${e.additionalInstructions}`);let s=e?.toolsList?.length?e.toolsList.join(", "):`
 - None provided`;return t.push(`## TOOL HINTS
You have access to the following tools: ${s}`),t.push(ue),t.join(`

`)}handoffAgentToTools(e){return e.map(t=>R(b(t.name),oe__default.default`You are a ${t.name}. Use this tool to ${t.goal??t.background}`,zod.z.object({prompt:zod.z.string().describe("The prompt of the request.")}),async({prompt:s})=>{let n=await t.chat(s);return n?.completion?.content||n}))}toolsToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.schema.function.name} [${b(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.name} [${b(t.name)}]: Its role is to ${t.background}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}async stream(e){return this.addPrompt(e),this.client.stream(e)}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new o(e)}};var U=class o extends E{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new o({...e,position:"orchestrator"})}};var ve=3e4,T=class{constructor(e){this.config=e;}process=null;messageId=0;pendingRequests=new Map;buffer="";isInitialized=false;async connect(){if(!this.process)return new Promise((e,t)=>{if(this.process=child_process.spawn(this.config.command,this.config.args,{env:{...process.env,...this.config.env},stdio:["pipe","pipe","pipe"]}),!this.process.stdout||!this.process.stdin){t(new Error("Failed to create MCP server process"));return}this.process.stdout.on("data",s=>{this.handleData(s);}),this.process.stderr?.on("data",s=>{console.error("[MCP Server Error]:",s.toString());}),this.process.on("error",s=>{t(s);}),this.process.on("exit",s=>{console.log(`[MCP Server] Process exited with code ${s}`),this.cleanup();}),this.sendRequest("initialize",{protocolVersion:"2024-11-05",capabilities:{},clientInfo:{name:"micro-ai-ts",version:"0.6.4"}}).then(()=>{this.isInitialized=true,e();}).catch(t);})}handleData(e){this.buffer+=e.toString();let t=this.buffer.split(`
`);this.buffer=t.pop()||"";for(let s of t)if(s.trim())try{let n=JSON.parse(s);this.handleMessage(n);}catch(n){console.error("[MCP Client] Failed to parse message:",s,n);}}handleMessage(e){if(e.id!==void 0){let t=this.pendingRequests.get(e.id);t&&(this.pendingRequests.delete(e.id),e.error?t.reject(new Error(e.error.message||"MCP Error")):t.resolve(e.result));}}sendRequest(e,t){return new Promise((s,n)=>{if(!this.process?.stdin){n(new Error("MCP server not connected"));return}let r=++this.messageId,i={jsonrpc:"2.0",id:r,method:e,params:t};this.pendingRequests.set(r,{resolve:s,reject:n});try{this.process.stdin.write(JSON.stringify(i)+`
`);}catch(a){this.pendingRequests.delete(r),n(a);}setTimeout(()=>{this.pendingRequests.has(r)&&(this.pendingRequests.delete(r),n(new Error(`Request timeout: ${e}`)));},ve);})}async listTools(){return this.isInitialized||await this.connect(),(await this.sendRequest("tools/list")).tools||[]}async callTool(e,t){this.isInitialized||await this.connect();let s=await this.sendRequest("tools/call",{name:e,arguments:t});return s.content&&Array.isArray(s.content)?s.content.filter(n=>n.type==="text").map(n=>n.text).join(`
`):s}async disconnect(){this.process&&(this.process.kill(),this.cleanup());}cleanup(){this.process=null,this.isInitialized=false,this.pendingRequests.clear(),this.buffer="";}};function D(o){if(!o||typeof o!="object")return zod.z.any();switch(o.type){case "string":return zod.z.string();case "number":return zod.z.number();case "integer":return zod.z.number().int();case "boolean":return zod.z.boolean();case "array":return o.items?zod.z.array(D(o.items)):zod.z.array(zod.z.any());case "object":if(o.properties){let t={};for(let[s,n]of Object.entries(o.properties)){let r=D(n);o.required?.includes(s)||(r=r.optional()),t[s]=r;}return zod.z.object(t)}return zod.z.record(zod.z.any());default:return zod.z.any()}}var K=[],O=async()=>{let o=[...K];K.length=0;for(let e of o)try{await e.disconnect();}catch{}};typeof process<"u"&&(process.on("beforeExit",()=>{O();}),process.on("SIGINT",()=>{O().then(()=>process.exit(0));}),process.on("SIGTERM",()=>{O().then(()=>process.exit(0));}));async function ne(){await O();}async function q(o,e){let t=new T(o);try{await t.connect();let s=await t.listTools(),n=e?s.filter(i=>e.includes(i.name)):s;if(n.length===0)return console.warn("[MCP] No tools found matching criteria"),[];let r=n.map(i=>{let a=D(i.inputSchema);return R(i.name,i.description||`MCP tool: ${i.name}`,a,async p=>{try{return await t.callTool(i.name,p)}catch(d){throw new Error(`MCP tool error: ${d.message}`)}})});return K.push(t),r}catch(s){throw await t.disconnect(),new Error(`Failed to create MCP tools: ${s.message}`)}}async function re(o,e){let t=await q(o,[e]);if(t.length===0)throw new Error(`MCP tool "${e}" not found`);return t[0]}Object.defineProperty(exports,"z",{enumerable:true,get:function(){return zod.z}});exports.Agent=E;exports.MCPClient=T;exports.Micro=x;exports.Orchestrator=U;exports.Providers=A;exports.createMCPTool=re;exports.createMCPTools=q;exports.createProvider=me;exports.createTool=R;exports.del=j;exports.disconnectAllMCPClients=ne;exports.get=B;exports.head=F;exports.http=W;exports.httpClient=S;exports.options=J;exports.parseTemplate=v;exports.patch=G;exports.post=z;exports.put=Y;exports.randomId=I;exports.slugify=b;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map