'use strict';require('dotenv/config');var te=require('hyperid'),z=require('dedent'),zod=require('zod'),zodToJsonSchema=require('zod-to-json-schema');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var te__default=/*#__PURE__*/_interopDefault(te);var z__default=/*#__PURE__*/_interopDefault(z);var V=Object.defineProperty;var X=(s,e)=>{for(var t in e)V(s,t,{get:e[t],enumerable:true});};function Z(s){let{model:e,...t}=s;return {provider:t,model:e}}var _={openai:(s="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:s}),groq:(s="llama-3.3-70b-versatile")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:s}),gemini:(s="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:s}),ai302:(s="gpt-4.1-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:s}),openrouter:(s="openai/gpt-4.1-mini")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:s}),deepseek:(s="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:s}),grok:(s="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:s})};var $={};X($,{del:()=>D,get:()=>w,head:()=>U,httpClient:()=>O,options:()=>K,patch:()=>I,post:()=>L,put:()=>N});var ee=["POST","post","PUT","put","PATCH","patch"];async function h(s){let{baseURL:e,endpoint:t,headers:i,body:o,timeout:n,method:r="POST",stream:l=false}=s,a=new AbortController,c=n?setTimeout(()=>a.abort(),n):void 0;try{let m={method:r,headers:i,signal:a.signal};o&&ee.includes(r)&&(m.body=JSON.stringify(o));let p=await fetch(`${e}${t}`,m);if(c&&clearTimeout(c),!p.ok){let d=await p.json().catch(()=>({})),f=new Error(d.error?.message||`HTTP error! status: ${p.status}`);throw f.response={status:p.status,data:d},f.code="HTTP_ERROR",f}return l?p:await p.json()}catch(m){if(c&&clearTimeout(c),m.name==="AbortError"){let p=new Error("Request timeout");throw p.code="ECONNABORTED",p}throw m}}async function O(s){return h(s)}async function w(s){return h({...s,method:"GET"})}async function L(s){return h({...s,method:"POST"})}async function N(s){return h({...s,method:"PUT"})}async function I(s){return h({...s,method:"PATCH"})}async function D(s){return h({...s,method:"DELETE"})}async function U(s){return h({...s,method:"HEAD"})}async function K(s){return h({...s,method:"OPTIONS"})}function S(){return te__default.default({urlSafe:true})()}function g(s,e={}){return s.replace(/\{\{(\w+)\}\}/g,(t,i)=>e[i]!==void 0?String(e[i]):t)}function H(s){let e=s.split(":");return e.length>1?e[1]??s:s}function q(s){let e=s.split(":");return e.length>1?e[0]??"":""}function R(s,e){return new RegExp(`<${e}>`,"i").test(s)}function v(s,e){let t=new RegExp(`<${e}>`,"gi"),i=new RegExp(`</${e}>`,"gi");return s.replace(t,"").replace(i,"")}function T(s,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),i=s.match(t);return i&&i[1]?i[1].trim():""}function B(s){return s.startsWith("data:")&&s.includes(";base64,")}function b(s){return s.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function G(s,e=1){return e<=0?[]:e>=s.length?[...s]:s.slice(-e)}function Y(s){return s.filter(e=>e!=="")}function j(s){if(!s)return s;let e={...s};if(e.apiKey&&typeof e.apiKey=="string"){let t=e.apiKey,i=10,o=8,n=i+o;if(t.length>n){let r=t.substring(0,i),l=t.substring(t.length-o),a=t.length-n;e.apiKey=`${r}${"\u2022".repeat(a)}${l}`;}else if(t.length>i){let r=t.substring(0,i);e.apiKey=`${r}${"\u2022".repeat(t.length-i)}`;}else e.apiKey="\u2022".repeat(t.length);}return e}var u={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4o-mini",temperature:0,defaultEndpointCompletionSuffix:"/chat/completions"},M=class{baseURL;headers;model;systemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;streamEnabled;parsedSystemPrompt;defaultProvider;modelName;providerName;identifier;timeout;reasoning_effort;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;debug;reasoning;isReasoningModel;isGemini25Reasoning;isOpenAIReasoning;isOpenAI5;isGLMReasoning;isQWQ;isDeepseekReasoning;isQwen3;constructor(e={}){this.identifier=S(),this.timeout=e?.timeout,this.modelName=H(e?.model||"")||u.model,this.providerName=q(e?.model||"")||u.providerName;let t;if(this.providerName){let i=_[this.providerName];i&&(t=i(this.modelName));}if(this.defaultProvider={baseURL:t?.baseURL??e?.provider?.baseURL??u.baseURL,apiKey:t?.apiKey??e?.provider?.apiKey??u.apiKey,...e?.provider?.headers&&{headers:e.provider.headers}},!this.defaultProvider.apiKey)throw new Error("API Key is required");this.baseURL=this.defaultProvider.baseURL,this.headers={Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers},this.model=this.modelName,this.systemPrompt=e?.systemPrompt||"",this.prompt=e?.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?g(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature!==void 0?e.temperature:u.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.debug=e?.debug||false,this.streamEnabled=e?.stream||false,this.reasoning=e?.reasoning??true,this.reasoning_effort=e.reasoning_effort??"medium",this.isOpenAI5=this.model?.toLowerCase()?.includes("gpt-5"),this.isOpenAIReasoning=this.model?.toLowerCase()?.includes("o1")||this.model?.toLowerCase()?.includes("o3")||this.model?.toLowerCase()?.includes("o4")||this.isOpenAI5,this.isGemini25Reasoning=this.model?.toLowerCase()?.includes("gemini-2.5"),this.isGLMReasoning=this.model?.toLowerCase()?.includes("glm-4."),this.isQWQ=this.model?.toLowerCase()?.includes("qwq"),this.isDeepseekReasoning=this.model?.toLowerCase()?.includes("deepseek-reasoner")||this.model?.toLowerCase()?.includes("deepseek-r1"),this.isQwen3=this.model?.toLowerCase()?.includes("qwen3"),this.isReasoningModel=this.isGemini25Reasoning||this.isOpenAIReasoning||this.isGLMReasoning||this.isQWQ||this.isDeepseekReasoning||this.isQwen3,this.onComplete=e.onComplete||void 0,this.onMessage=e.onMessage||void 0,this.onRequest=e.onRequest||void 0,this.onResponseData=e.onResponseData||void 0,this.onError=e.onError||void 0,this.onToolCall=e.onToolCall||void 0,this.messages=e?.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&(console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",j(this.defaultProvider)),console.log(`=============================================
`));}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){e&&(this.parsedSystemPrompt=g(e,this.context),this.parsedSystemPrompt&&!this.getSystemMessage().length&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt}));}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),i=this.getNonSystemMessages(),o=G(i,e),n=[...t,...o];return this.messages=n,this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let i=g(e,this.context);this.prompt=i,t&&B(t)?this.messages.push({role:"user",content:[{type:"text",text:i},{type:"image_url",image_url:{url:t}}]}):this.messages.push({role:"user",content:i}),this.onMessage&&this.onMessage(this.messages);}setAssistantMessage(e){let t=g(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage&&this.onMessage(this.messages),this}async makeRequest(e=false){let t={model:this.model,messages:this.messages,stream:e||this.streamEnabled};if(this.temperature&&(t.temperature=this.temperature),this.maxTokens&&(t.max_tokens=this.maxTokens),this.tools&&this.tools.length>0&&(t.tools=this.tools.map(o=>o.schema),this.tool_choice&&(t.tool_choice=this.tool_choice)),this.reasoning&&this.isReasoningModel)if(this.isOpenAIReasoning)t.reasoning_effort=this.reasoning_effort,this.maxTokens&&(t.max_completion_tokens=this.maxTokens,delete t.max_tokens);else if(this.isGemini25Reasoning){let o={minimal:2048,low:4096,medium:8192,high:16384};t.extra_body={google:{thinking_config:{thinking_budget:o[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.isGLMReasoning&&(t.thinking={type:"enabled"});this.onRequest&&this.onRequest(t);let i=await O({baseURL:this.baseURL,endpoint:u.defaultEndpointCompletionSuffix,headers:this.headers,body:t,timeout:this.timeout,method:"POST",stream:e||this.streamEnabled});return this.onResponseData&&!e&&this.onResponseData(i),i}async executeTool(e,t){let i=this.tools?.find(o=>o.schema.function.name===e);if(!i){let o=`Tool "${e}" not found`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:o}),o}try{let o=JSON.parse(t),n=await i.execute(o);return this.onToolCall&&this.onToolCall({toolName:e,arguments:o,result:n}),n}catch(o){let n=`Error executing tool "${e}": ${o.message}`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:n}),n}}async handleToolCalls(e){for(let t of e){let i=t.function.name,o=t.function.arguments,n=await this.executeTool(i,o);this.messages.push({role:"tool",tool_call_id:t.id,name:i,content:typeof n=="string"?n:JSON.stringify(n)}),this.onMessage&&this.onMessage(this.messages);}}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),o=t.choices?.[0]?.message;if(o&&(this.messages.push(o),this.onMessage&&this.onMessage(this.messages)),o?.tool_calls&&o.tool_calls.length>0)return await this.handleToolCalls(o.tool_calls),this.invoke();let r=Date.now()-e,l="",a=o?.content||"",c=!1;this.reasoning&&this.isReasoningModel&&a&&(R(a,"thinking")?(l=T(a,"thinking"),a=v(a,"thinking"),c=!0):R(a,"think")&&(l=T(a,"think"),a=v(a,"think"),c=!0));let m={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t.usage,timing:{latencyMs:r,latencySeconds:r/1e3},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:c}},fullResponse:t,completion:{role:o?.role||"assistant",content:a.trim(),reasoning:l.trim(),original:o?.content||""}};return this.onComplete&&this.onComplete(m,this.messages),m}catch(t){let n={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:t.code==="ECONNABORTED"?"timeout":"api_error",message:t.message,status:t.response?.status,code:t.code,details:t.response?.data}};return this.onError&&this.onError(n.error),Promise.reject(n.error)}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}async*processStream(e,t){let i=e.body?.getReader();if(!i)throw new Error("Stream not available");let o=new TextDecoder,n="",r="",l="assistant",a="";try{for(;;){let{done:W,value:F}=await i.read();if(W)break;a+=o.decode(F,{stream:!0});let C=a.split(`
`);a=C.pop()||"";for(let J of C){let P=J.trim();if(!(!P||P==="data: [DONE]")&&P.startsWith("data: "))try{let A=P.slice(6),y=JSON.parse(A).choices?.[0]?.delta;y?.role&&(l=y.role),y?.content&&(n+=y.content,yield {delta:y.content,fullContent:n,done:!1});}catch{}}}this.reasoning&&this.isReasoningModel&&n&&(R(n,"thinking")?(r=T(n,"thinking"),n=v(n,"thinking")):R(n,"think")&&(r=T(n,"think"),n=v(n,"think"))),this.messages.push({role:l,content:n}),this.onMessage&&this.onMessage(this.messages);let m=Date.now()-t,p={id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:m,latencySeconds:m/1e3},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:r.length>0}},d={role:l,content:n.trim(),reasoning:r.trim(),original:n},f={metadata:p,completion:d};this.onComplete&&this.onComplete(f,this.messages),yield {delta:"",fullContent:n.trim(),reasoning:r.trim(),done:!0,metadata:p,completion:d};}catch(c){let d={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:"api_error",message:c.message}};throw this.onError&&this.onError(d.error),d.error}}async stream(e,t){this.setUserMessage(e,t);let i=Date.now();try{let o=await this.makeRequest(!0);return this.processStream(o,i)}catch(o){let l={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:o.code==="ECONNABORTED"?"timeout":"api_error",message:o.message,status:o.response?.status,code:o.code,details:o.response?.data}};throw this.onError&&this.onError(l.error),l.error}}};function x(s,e,t,i){let o=zodToJsonSchema.zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),n=o.properties||{},r=o.required||[];return {schema:{type:"function",function:{name:s,description:e,parameters:{type:"object",properties:n,required:r,additionalProperties:false}}},execute:i}}var oe=z__default.default`
You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first think about it, then if necessary, use the tools to get the information you need.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin!
`,ie={model:"gpt-4o-mini"},E=class s{client;name;background;goal;position;handoffs;tools;model;constructor(e){this.name=e.name,this.background=e.background,this.goal=e.goal,this.handoffs=e.handoffs||[],this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.background,goal:e.goal,additionalInstructions:e.additionalInstructions,toolsList:Y([this.handoffAgentToStringList(this.handoffs),this.toolsToStringList(this.tools)]),...e.context||{}};this.client=new M({systemPrompt:this.buildSystemPrompt({role:t.role,background:t.background,goal:t.goal,additionalInstructions:t.additionalInstructions,toolsList:t.toolsList||[]}),maxTokens:e.maxTokens||4e3,temperature:e.temperature??0,model:this.model||ie.model,debug:e.debug||false,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,stream:e.stream,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}buildSystemPrompt(e){let t=[];e?.role&&t.push(`# ROLE
You are a ${e.role}.`),e?.background&&t.push(`## BACKGROUND
${e.background}.`),e?.goal&&t.push(`## MAIN GOAL
${e.goal}`),e?.additionalInstructions&&t.push(`## ADDITIONAL INSTRUCTIONS
${e.additionalInstructions}`);let i=e?.toolsList?.length?e.toolsList.join(", "):`
 - None provided`;return t.push(`## TOOL HINTS
You have access to the following tools: ${i}`),t.push(oe),t.join(`

`)}handoffAgentToTools(e){return e.map(t=>x(b(t.name),z__default.default`You are a ${t.name}. Use this tool to ${t.goal??t.background}`,zod.z.object({prompt:zod.z.string().describe("The prompt of the request.")}),async({prompt:i})=>{let o=await t.chat(i);return o?.completion?.content||o}))}toolsToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.schema.function.name} [${b(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.name} [${b(t.name)}]: Its role is to ${t.background}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new s(e)}},k=class s extends E{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new s({...e,position:"orchestrator"})}};Object.defineProperty(exports,"z",{enumerable:true,get:function(){return zod.z}});exports.Agent=E;exports.Micro=M;exports.Orchestrator=k;exports.Providers=_;exports.createProvider=Z;exports.createTool=x;exports.del=D;exports.get=w;exports.head=U;exports.http=$;exports.httpClient=O;exports.options=K;exports.parseTemplate=g;exports.patch=I;exports.post=L;exports.put=N;exports.randomId=S;exports.slugify=b;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map