import'dotenv/config';import se from'hyperid';import W from'dedent';import {z as z$1}from'zod';export{z}from'zod';import {zodToJsonSchema}from'zod-to-json-schema';var X=Object.defineProperty;var Z=(o,e)=>{for(var t in e)X(o,t,{get:e[t],enumerable:true});};function ee(o){let{model:e,...t}=o;return {provider:t,model:e}}var O={openai:(o="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:o}),groq:(o="llama-3.3-70b-versatile")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:o}),gemini:(o="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:o}),ai302:(o="gpt-4.1-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:o}),openrouter:(o="openai/gpt-4.1-mini")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:o}),deepseek:(o="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:o}),grok:(o="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:o}),fireworks:(o="accounts/fireworks/models/llama4-maverick-instruct-basic")=>({apiKey:process.env.FIREWORKS_API_KEY||"",baseURL:process.env.FIREWORKS_BASE_URL||"https://api.fireworks.ai/inference/v1",model:o}),mistral:(o="mistral-large-latest")=>({apiKey:process.env.MISTRAL_API_KEY||"",baseURL:process.env.MISTRAL_BASE_URL||"https://api.mistral.ai/v1",model:o}),together:(o="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo")=>({apiKey:process.env.TOGETHER_API_KEY||"",baseURL:process.env.TOGETHER_BASE_URL||"https://api.together.xyz/v1",model:o})};var H={};Z(H,{del:()=>D,get:()=>C,head:()=>K,httpClient:()=>T,options:()=>$,patch:()=>U,post:()=>w,put:()=>N});var te=["POST","post","PUT","put","PATCH","patch"];async function g(o){let{baseURL:e,endpoint:t,headers:s,body:i,timeout:r,method:n="POST",stream:l=false}=o,p=new AbortController,c=r?setTimeout(()=>p.abort(),r):void 0;try{let m={method:n,headers:s,signal:p.signal};i&&te.includes(n)&&(m.body=JSON.stringify(i));let a=await fetch(`${e}${t}`,m);if(c&&clearTimeout(c),!a.ok){let d=await a.json().catch(()=>({})),f=new Error(d.error?.message||`HTTP error! status: ${a.status}`);throw f.response={status:a.status,data:d},f.code="HTTP_ERROR",f}return l?a:await a.json()}catch(m){if(c&&clearTimeout(c),m.name==="AbortError"){let a=new Error("Request timeout");throw a.code="ECONNABORTED",a}throw m}}async function T(o){return g(o)}async function C(o){return g({...o,method:"GET"})}async function w(o){return g({...o,method:"POST"})}async function N(o){return g({...o,method:"PUT"})}async function U(o){return g({...o,method:"PATCH"})}async function D(o){return g({...o,method:"DELETE"})}async function K(o){return g({...o,method:"HEAD"})}async function $(o){return g({...o,method:"OPTIONS"})}function _(){return se({urlSafe:true})()}function u(o,e={}){return o.replace(/\{\{(\w+)\}\}/g,(t,s)=>e[s]!==void 0?String(e[s]):t)}function q(o){let e=o.split(":");return e.length===2?e[1]||"":e.length===3?`${e[1]}:${e[2]}`:o}function B(o){let e=o.split(":");return e.length>1?e[0]??"":""}function S(o,e){return new RegExp(`<${e}>`,"i").test(o)}function A(o,e){let t=new RegExp(`<${e}>`,"gi"),s=new RegExp(`</${e}>`,"gi");return o.replace(t,"").replace(s,"")}function L(o,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),s=o.match(t);return s&&s[1]?s[1].trim():""}function Y(o){return o.startsWith("data:")&&o.includes(";base64,")}function y(o){return o.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function G(o,e=1){return e<=0?[]:e>=o.length?[...o]:o.slice(-e)}function z(o){return o.filter(e=>e!=="")}function j(o){if(!o)return o;let e={...o};if(e.apiKey&&typeof e.apiKey=="string"){let t=e.apiKey,s=10,i=8,r=s+i;if(t.length>r){let n=t.substring(0,s),l=t.substring(t.length-i),p=t.length-r;e.apiKey=`${n}${"\u2022".repeat(p)}${l}`;}else if(t.length>s){let n=t.substring(0,s);e.apiKey=`${n}${"\u2022".repeat(t.length-s)}`;}else e.apiKey="\u2022".repeat(t.length);}return e}var R={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4.1-mini",defaultEndpointCompletionSuffix:"/chat/completions"},v=class{identifier;baseURL;headers;model;modelName;providerName;defaultProvider;capabilities;debug;streamEnabled;timeout;systemPrompt;parsedSystemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;reasoning;reasoning_effort;override;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;constructor(e={}){this.identifier=_(),this.timeout=e.timeout,this.debug=e.debug??false,this.streamEnabled=e.stream??false,this.modelName=q(e.model||"")||R.model,this.providerName=B(e.model||"")||R.providerName,this.model=this.modelName,this.defaultProvider=this.initializeProvider(e),this.baseURL=this.defaultProvider.baseURL,this.headers=this.buildHeaders(),this.capabilities=this.detectModelCapabilities(),this.reasoning=e.reasoning??this.capabilities.isReasoningModel,this.reasoning_effort=this.reasoning?e.reasoning_effort??"medium":void 0,this.systemPrompt=e.systemPrompt||"",this.prompt=e.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?u(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.override=e.override,this.onComplete=e.onComplete,this.onMessage=e.onMessage,this.onRequest=e.onRequest,this.onResponseData=e.onResponseData,this.onError=e.onError,this.onToolCall=e.onToolCall,this.messages=e.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&this.logDebugInfo();}initializeProvider(e){let t=O[this.providerName],s=t?.(this.modelName),i={baseURL:s?.baseURL??e.provider?.baseURL??R.baseURL,apiKey:s?.apiKey??e.provider?.apiKey??R.apiKey,...e.provider?.headers&&{headers:e.provider.headers}};if(!i.apiKey)throw new Error("API Key is required");return i}buildHeaders(){return {Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers}}detectModelCapabilities(){let e=this.model.toLowerCase(),t=e.includes("gpt-5"),s=["o1","o3","o4"].some(a=>e.includes(a))||t,i=e.includes("gemini-2.5"),r=e.includes("glm-4."),n=e.includes("qwq"),l=e.includes("deepseek-reasoner")||e.includes("deepseek-r1"),p=e.includes("qwen3"),c=e.includes("-m2");return {isOpenAI5:t,isOpenAIReasoning:s,isGemini25Reasoning:i,isGLMReasoning:r,isQWQ:n,isDeepseekReasoning:l,isQwen3:p,isMinimaxM2:c,isReasoningModel:i||s||r||n||l||p||c}}logDebugInfo(){console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",j(this.defaultProvider)),console.log(`=============================================
`);}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.capabilities.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel,reasoning_effort:this.reasoning_effort}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){if(!e)return;this.parsedSystemPrompt=u(e,this.context);let t=this.messages.some(s=>s.role==="system");this.parsedSystemPrompt&&!t&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt});}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),s=this.getNonSystemMessages(),i=G(s,e);return this.messages=[...t,...i],this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let s=u(e,this.context);this.prompt=s;let i=t&&Y(t)?[{type:"text",text:s},{type:"image_url",image_url:{url:t}}]:s;this.messages.push({role:"user",content:i}),this.onMessage?.(this.messages);}setAssistantMessage(e){let t=u(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage?.(this.messages),this}buildRequestBody(e){let t={model:this.model,messages:this.messages,stream:e||this.streamEnabled};return this.temperature!==void 0&&(t.temperature=this.temperature),this.maxTokens&&(t.max_tokens=this.maxTokens),this.tools?.length&&(t.tools=this.tools.map(s=>s.schema),this.tool_choice&&(t.tool_choice=this.tool_choice)),this.reasoning&&this.capabilities.isReasoningModel&&this.applyReasoningConfig(t),this.override&&(t={...t,...this.override}),t}applyReasoningConfig(e){if(this.capabilities.isOpenAIReasoning)e.reasoning_effort=this.reasoning_effort,this.maxTokens&&(e.max_completion_tokens=this.maxTokens,delete e.max_tokens);else if(this.capabilities.isGemini25Reasoning){let t={minimal:2048,low:4096,medium:8192,high:16384};e.extra_body={google:{thinking_config:{thinking_budget:t[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.capabilities.isGLMReasoning&&(e.thinking={type:"enabled"});}async makeRequest(e=false){let t=this.buildRequestBody(e);this.onRequest?.(t);let s=await T({baseURL:this.baseURL,endpoint:R.defaultEndpointCompletionSuffix,headers:this.headers,body:t,timeout:this.timeout,method:"POST",stream:e||this.streamEnabled});return e||this.onResponseData?.(s),s}async executeTool(e,t){let s=this.tools?.find(i=>i.schema.function.name===e);if(!s){let i=`Tool "${e}" not found`;return this.onToolCall?.({toolName:e,arguments:t,result:null,error:i}),i}try{let i=JSON.parse(t),r=await s.execute(i);return this.onToolCall?.({toolName:e,arguments:i,result:r}),r}catch(i){let r=`Error executing tool "${e}": ${i.message}`;return this.onToolCall?.({toolName:e,arguments:t,result:null,error:r}),r}}async handleToolCalls(e){for(let t of e){let s=await this.executeTool(t.function.name,t.function.arguments);this.messages.push({role:"tool",tool_call_id:t.id,name:t.function.name,content:typeof s=="string"?s:JSON.stringify(s)}),this.onMessage?.(this.messages);}}extractReasoning(e){let t=e?.reasoning||e?.reasoning_content||"",s=e?.content||"";return S(s,"thinking")?(t=L(s,"thinking"),s=A(s,"thinking")):S(s,"thought")&&(t=L(s,"thought"),s=A(s,"thought")),{reasoning:t,content:s}}buildResponse(e,t,s,i,r){return {metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:e.usage,timing:{latencyMs:t,latencySeconds:t/1e3},timestamp:new Date().toISOString(),context:this.context,isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel||s.length>0,reasoning_effort:this.reasoning_effort,hasThoughts:s.length>0},fullResponse:e,completion:{role:r?.role||"assistant",content:i.trim(),reasoning:s.trim(),original:r?.content||""}}}buildErrorResponse(e,t){return {metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:t,latencySeconds:t/1e3},timestamp:new Date().toISOString(),context:this.context},completion:{role:"assistant",content:"",original:""},error:{type:e.code==="ECONNABORTED"?"timeout":"api_error",message:e.message,status:e.response?.status,code:e.code,details:e.response?.data}}}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),s=t.choices?.[0]?.message;if(s&&(this.messages.push(s),this.onMessage?.(this.messages)),s?.tool_calls?.length)return await this.handleToolCalls(s.tool_calls),this.invoke();let i=Date.now()-e,{reasoning:r,content:n}=this.extractReasoning(s),l=this.buildResponse(t,i,r,n,s);return this.onComplete?.(l,this.messages),l}catch(t){let s=Date.now()-e,i=this.buildErrorResponse(t,s);return this.onError?.(i.error),Promise.reject(i.error)}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}buildStreamMetadata(e,t,s){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t,timing:{latencyMs:e,latencySeconds:e/1e3},timestamp:new Date().toISOString(),context:this.context,isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:s.length>0}}async*processStream(e,t){let s=e.body?.getReader();if(!s)throw new Error("Stream not available");let i=new TextDecoder,r="",n="",l="assistant",p="",c;try{for(;;){let{done:J,value:Q}=await s.read();if(J)break;p+=i.decode(Q,{stream:!0});let I=p.split(`
`);p=I.pop()||"";for(let V of I){let b=V.trim();if(!(!b||b==="data: [DONE]")&&b.startsWith("data: "))try{let E=JSON.parse(b.slice(6)),h=E.choices?.[0]?.delta;h?.role&&(l=h.role);let x=h?.reasoning||h?.reasoning_content;(h?.content||x)&&(r+=h.content||"",n+=x||"",yield {delta:h.content,reasoning:x,fullContent:r,done:!1}),E.usage&&(c=E.usage);}catch{}}}this.messages.push({role:l,content:r}),this.onMessage?.(this.messages);let m=Date.now()-t,a=this.buildStreamMetadata(m,c,n),d={role:l,content:r.trim(),reasoning:n.trim(),original:r},f={metadata:a,completion:d};this.onComplete?.(f,this.messages),yield {delta:"",fullContent:r.trim(),reasoning:n.trim(),done:!0,metadata:a,completion:d};}catch(m){let a=Date.now()-t,d=this.buildErrorResponse(m,a);throw this.onError?.(d.error),d.error}}async stream(e,t){this.setUserMessage(e,t);let s=Date.now();try{let i=await this.makeRequest(!0);return this.processStream(i,s)}catch(i){let r=Date.now()-s,n=this.buildErrorResponse(i,r);throw this.onError?.(n.error),n.error}}};function P(o,e,t,s){let i=zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),r=i.properties||{},n=i.required||[];return {schema:{type:"function",function:{name:o,description:e,parameters:{type:"object",properties:r,required:n,additionalProperties:false}}},execute:s}}var ie=W`
You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first think about it, then if necessary, use the tools to get the information you need.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin!
`,re={model:"gpt-4o-mini"},M=class o{client;name;background;goal;position;handoffs;tools;model;constructor(e){this.name=e.name,this.background=e.background,this.goal=e.goal,this.handoffs=e.handoffs||[],this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.background,goal:e.goal,additionalInstructions:e.additionalInstructions,toolsList:z([this.handoffAgentToStringList(this.handoffs),this.toolsToStringList(this.tools)]),...e.context||{}};this.client=new v({systemPrompt:this.buildSystemPrompt({role:t.role,background:t.background,goal:t.goal,additionalInstructions:t.additionalInstructions,toolsList:t.toolsList||[]}),maxTokens:e.maxTokens||4e3,temperature:e.temperature??0,model:this.model||re.model,debug:e.debug||false,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,stream:e.stream,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}buildSystemPrompt(e){let t=[];e?.role&&t.push(`# ROLE
You are a ${e.role}.`),e?.background&&t.push(`## BACKGROUND
${e.background}.`),e?.goal&&t.push(`## MAIN GOAL
${e.goal}`),e?.additionalInstructions&&t.push(`## ADDITIONAL INSTRUCTIONS
${e.additionalInstructions}`);let s=e?.toolsList?.length?e.toolsList.join(", "):`
 - None provided`;return t.push(`## TOOL HINTS
You have access to the following tools: ${s}`),t.push(ie),t.join(`

`)}handoffAgentToTools(e){return e.map(t=>P(y(t.name),W`You are a ${t.name}. Use this tool to ${t.goal??t.background}`,z$1.object({prompt:z$1.string().describe("The prompt of the request.")}),async({prompt:s})=>{let i=await t.chat(s);return i?.completion?.content||i}))}toolsToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.schema.function.name} [${y(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.name} [${y(t.name)}]: Its role is to ${t.background}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new o(e)}},k=class o extends M{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new o({...e,position:"orchestrator"})}};export{M as Agent,v as Micro,k as Orchestrator,O as Providers,ee as createProvider,P as createTool,D as del,C as get,K as head,H as http,T as httpClient,$ as options,u as parseTemplate,U as patch,w as post,N as put,_ as randomId,y as slugify};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map