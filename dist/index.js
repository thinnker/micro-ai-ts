import'dotenv/config';import oe from'hyperid';import Q from'dedent';import {z}from'zod';export{z}from'zod';import {zodToJsonSchema}from'zod-to-json-schema';var Z=Object.defineProperty;var ee=(s,e)=>{for(var t in e)Z(s,t,{get:e[t],enumerable:true});};function te(s){let{model:e,...t}=s;return {provider:t,model:e}}var S={openai:(s="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:s}),groq:(s="llama-3.3-70b-versatile")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:s}),gemini:(s="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:s}),ai302:(s="gpt-4.1-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:s}),openrouter:(s="openai/gpt-4.1-mini")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:s}),deepseek:(s="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:s}),grok:(s="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:s}),fireworks:(s="accounts/fireworks/models/llama4-maverick-instruct-basic")=>({apiKey:process.env.FIREWORKS_API_KEY||"",baseURL:process.env.FIREWORKS_BASE_URL||"https://api.fireworks.ai/inference/v1",model:s}),mistral:(s="mistral-large-latest")=>({apiKey:process.env.MISTRAL_API_KEY||"",baseURL:process.env.MISTRAL_BASE_URL||"https://api.mistral.ai/v1",model:s}),together:(s="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo")=>({apiKey:process.env.TOGETHER_API_KEY||"",baseURL:process.env.TOGETHER_BASE_URL||"https://api.together.xyz/v1",model:s})};var $={};ee($,{del:()=>D,get:()=>C,head:()=>U,httpClient:()=>E,options:()=>K,patch:()=>N,post:()=>I,put:()=>w});var se=["POST","post","PUT","put","PATCH","patch"];async function g(s){let{baseURL:e,endpoint:t,headers:i,body:o,timeout:n,method:r="POST",stream:p=false}=s,a=new AbortController,m=n?setTimeout(()=>a.abort(),n):void 0;try{let c={method:r,headers:i,signal:a.signal};o&&se.includes(r)&&(c.body=JSON.stringify(o));let l=await fetch(`${e}${t}`,c);if(m&&clearTimeout(m),!l.ok){let h=await l.json().catch(()=>({})),d=new Error(h.error?.message||`HTTP error! status: ${l.status}`);throw d.response={status:l.status,data:h},d.code="HTTP_ERROR",d}return p?l:await l.json()}catch(c){if(m&&clearTimeout(m),c.name==="AbortError"){let l=new Error("Request timeout");throw l.code="ECONNABORTED",l}throw c}}async function E(s){return g(s)}async function C(s){return g({...s,method:"GET"})}async function I(s){return g({...s,method:"POST"})}async function w(s){return g({...s,method:"PUT"})}async function N(s){return g({...s,method:"PATCH"})}async function D(s){return g({...s,method:"DELETE"})}async function U(s){return g({...s,method:"HEAD"})}async function K(s){return g({...s,method:"OPTIONS"})}function A(){return oe({urlSafe:true})()}function u(s,e={}){return s.replace(/\{\{(\w+)\}\}/g,(t,i)=>e[i]!==void 0?String(e[i]):t)}function H(s){let e=s.split(":");return e.length>1?e[1]??s:s}function q(s){let e=s.split(":");return e.length>1?e[0]??"":""}function R(s,e){return new RegExp(`<${e}>`,"i").test(s)}function v(s,e){let t=new RegExp(`<${e}>`,"gi"),i=new RegExp(`</${e}>`,"gi");return s.replace(t,"").replace(i,"")}function T(s,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),i=s.match(t);return i&&i[1]?i[1].trim():""}function B(s){return s.startsWith("data:")&&s.includes(";base64,")}function b(s){return s.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function G(s,e=1){return e<=0?[]:e>=s.length?[...s]:s.slice(-e)}function Y(s){return s.filter(e=>e!=="")}function j(s){if(!s)return s;let e={...s};if(e.apiKey&&typeof e.apiKey=="string"){let t=e.apiKey,i=10,o=8,n=i+o;if(t.length>n){let r=t.substring(0,i),p=t.substring(t.length-o),a=t.length-n;e.apiKey=`${r}${"\u2022".repeat(a)}${p}`;}else if(t.length>i){let r=t.substring(0,i);e.apiKey=`${r}${"\u2022".repeat(t.length-i)}`;}else e.apiKey="\u2022".repeat(t.length);}return e}var f={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4o-mini",temperature:0,defaultEndpointCompletionSuffix:"/chat/completions"},M=class{baseURL;headers;model;systemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;streamEnabled;parsedSystemPrompt;defaultProvider;modelName;providerName;identifier;timeout;reasoning_effort;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;debug;reasoning;isReasoningModel;isGemini25Reasoning;isOpenAIReasoning;isOpenAI5;isGLMReasoning;isQWQ;isDeepseekReasoning;isQwen3;constructor(e={}){this.identifier=A(),this.timeout=e?.timeout,this.modelName=H(e?.model||"")||f.model,this.providerName=q(e?.model||"")||f.providerName;let t;if(this.providerName){let i=S[this.providerName];i&&(t=i(this.modelName));}if(this.defaultProvider={baseURL:t?.baseURL??e?.provider?.baseURL??f.baseURL,apiKey:t?.apiKey??e?.provider?.apiKey??f.apiKey,...e?.provider?.headers&&{headers:e.provider.headers}},!this.defaultProvider.apiKey)throw new Error("API Key is required");this.baseURL=this.defaultProvider.baseURL,this.headers={Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers},this.model=this.modelName,this.systemPrompt=e?.systemPrompt||"",this.prompt=e?.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?u(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature!==void 0?e.temperature:f.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.debug=e?.debug||false,this.streamEnabled=e?.stream||false,this.isOpenAI5=this.model?.toLowerCase()?.includes("gpt-5"),this.isOpenAIReasoning=this.model?.toLowerCase()?.includes("o1")||this.model?.toLowerCase()?.includes("o3")||this.model?.toLowerCase()?.includes("o4")||this.isOpenAI5,this.isGemini25Reasoning=this.model?.toLowerCase()?.includes("gemini-2.5"),this.isGLMReasoning=this.model?.toLowerCase()?.includes("glm-4."),this.isQWQ=this.model?.toLowerCase()?.includes("qwq"),this.isDeepseekReasoning=this.model?.toLowerCase()?.includes("deepseek-reasoner")||this.model?.toLowerCase()?.includes("deepseek-r1"),this.isQwen3=this.model?.toLowerCase()?.includes("qwen3"),this.isReasoningModel=this.isGemini25Reasoning||this.isOpenAIReasoning||this.isGLMReasoning||this.isQWQ||this.isDeepseekReasoning||this.isQwen3,this.reasoning=e?.reasoning||!!this.isReasoningModel,this.reasoning_effort=e.reasoning_effort??"medium",this.onComplete=e.onComplete||void 0,this.onMessage=e.onMessage||void 0,this.onRequest=e.onRequest||void 0,this.onResponseData=e.onResponseData||void 0,this.onError=e.onError||void 0,this.onToolCall=e.onToolCall||void 0,this.messages=e?.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&(console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",j(this.defaultProvider)),console.log(`=============================================
`));}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){e&&(this.parsedSystemPrompt=u(e,this.context),this.parsedSystemPrompt&&!this.getSystemMessage().length&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt}));}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),i=this.getNonSystemMessages(),o=G(i,e),n=[...t,...o];return this.messages=n,this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let i=u(e,this.context);this.prompt=i,t&&B(t)?this.messages.push({role:"user",content:[{type:"text",text:i},{type:"image_url",image_url:{url:t}}]}):this.messages.push({role:"user",content:i}),this.onMessage&&this.onMessage(this.messages);}setAssistantMessage(e){let t=u(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage&&this.onMessage(this.messages),this}async makeRequest(e=false){let t={model:this.model,messages:this.messages,stream:e||this.streamEnabled};if(this.temperature&&(t.temperature=this.temperature),this.maxTokens&&(t.max_tokens=this.maxTokens),this.tools&&this.tools.length>0&&(t.tools=this.tools.map(o=>o.schema),this.tool_choice&&(t.tool_choice=this.tool_choice)),this.reasoning&&this.isReasoningModel)if(this.isOpenAIReasoning)t.reasoning_effort=this.reasoning_effort,this.maxTokens&&(t.max_completion_tokens=this.maxTokens,delete t.max_tokens);else if(this.isGemini25Reasoning){let o={minimal:2048,low:4096,medium:8192,high:16384};t.extra_body={google:{thinking_config:{thinking_budget:o[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.isGLMReasoning&&(t.thinking={type:"enabled"});this.onRequest&&this.onRequest(t);let i=await E({baseURL:this.baseURL,endpoint:f.defaultEndpointCompletionSuffix,headers:this.headers,body:t,timeout:this.timeout,method:"POST",stream:e||this.streamEnabled});return this.onResponseData&&!e&&this.onResponseData(i),i}async executeTool(e,t){let i=this.tools?.find(o=>o.schema.function.name===e);if(!i){let o=`Tool "${e}" not found`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:o}),o}try{let o=JSON.parse(t),n=await i.execute(o);return this.onToolCall&&this.onToolCall({toolName:e,arguments:o,result:n}),n}catch(o){let n=`Error executing tool "${e}": ${o.message}`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:n}),n}}async handleToolCalls(e){for(let t of e){let i=t.function.name,o=t.function.arguments,n=await this.executeTool(i,o);this.messages.push({role:"tool",tool_call_id:t.id,name:i,content:typeof n=="string"?n:JSON.stringify(n)}),this.onMessage&&this.onMessage(this.messages);}}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),o=t.choices?.[0]?.message;if(o&&(this.messages.push(o),this.onMessage&&this.onMessage(this.messages)),o?.tool_calls&&o.tool_calls.length>0)return await this.handleToolCalls(o.tool_calls),this.invoke();let r=Date.now()-e,p="",a=o?.content||"",m=!1;this.reasoning&&this.isReasoningModel&&a&&(R(a,"thinking")?(p=T(a,"thinking"),a=v(a,"thinking"),m=!0):R(a,"think")&&(p=T(a,"think"),a=v(a,"think"),m=!0));let c={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t.usage,timing:{latencyMs:r,latencySeconds:r/1e3},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:m}},fullResponse:t,completion:{role:o?.role||"assistant",content:a.trim(),reasoning:p.trim(),original:o?.content||""}};return this.onComplete&&this.onComplete(c,this.messages),c}catch(t){let n={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:t.code==="ECONNABORTED"?"timeout":"api_error",message:t.message,status:t.response?.status,code:t.code,details:t.response?.data}};return this.onError&&this.onError(n.error),Promise.reject(n.error)}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}async*processStream(e,t){let i=e.body?.getReader();if(!i)throw new Error("Stream not available");let o=new TextDecoder,n="",r="",p="assistant",a="",m;try{for(;;){let{done:F,value:J}=await i.read();if(F)break;a+=o.decode(J,{stream:!0});let L=a.split(`
`);a=L.pop()||"";for(let V of L){let P=V.trim();if(!(!P||P==="data: [DONE]")&&P.startsWith("data: "))try{let X=P.slice(6),_=JSON.parse(X),y=_.choices?.[0]?.delta;y?.role&&(p=y.role),y?.content&&(n+=y.content,yield {delta:y.content,fullContent:n,done:!1}),_.usage&&(m=_.usage||{});}catch{}}}this.reasoning&&this.isReasoningModel&&n&&(R(n,"thinking")?(r=T(n,"thinking"),n=v(n,"thinking")):R(n,"think")&&(r=T(n,"think"),n=v(n,"think"))),this.messages.push({role:p,content:n}),this.onMessage&&this.onMessage(this.messages);let l=Date.now()-t,h={id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:m,timing:{latencyMs:l,latencySeconds:l/1e3},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:r.length>0}},d={role:p,content:n.trim(),reasoning:r.trim(),original:n},W={metadata:h,completion:d};this.onComplete&&this.onComplete(W,this.messages),yield {delta:"",fullContent:n.trim(),reasoning:r.trim(),done:!0,metadata:h,completion:d};}catch(c){let d={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:"api_error",message:c.message}};throw this.onError&&this.onError(d.error),d.error}}async stream(e,t){this.setUserMessage(e,t);let i=Date.now();try{let o=await this.makeRequest(!0);return this.processStream(o,i)}catch(o){let p={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timestamp:new Date().toISOString(),context:this.context},error:{type:o.code==="ECONNABORTED"?"timeout":"api_error",message:o.message,status:o.response?.status,code:o.code,details:o.response?.data}};throw this.onError&&this.onError(p.error),p.error}}};function O(s,e,t,i){let o=zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),n=o.properties||{},r=o.required||[];return {schema:{type:"function",function:{name:s,description:e,parameters:{type:"object",properties:n,required:r,additionalProperties:false}}},execute:i}}var ne=Q`
You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first think about it, then if necessary, use the tools to get the information you need.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin!
`,re={model:"gpt-4o-mini"},x=class s{client;name;background;goal;position;handoffs;tools;model;constructor(e){this.name=e.name,this.background=e.background,this.goal=e.goal,this.handoffs=e.handoffs||[],this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.background,goal:e.goal,additionalInstructions:e.additionalInstructions,toolsList:Y([this.handoffAgentToStringList(this.handoffs),this.toolsToStringList(this.tools)]),...e.context||{}};this.client=new M({systemPrompt:this.buildSystemPrompt({role:t.role,background:t.background,goal:t.goal,additionalInstructions:t.additionalInstructions,toolsList:t.toolsList||[]}),maxTokens:e.maxTokens||4e3,temperature:e.temperature??0,model:this.model||re.model,debug:e.debug||false,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,stream:e.stream,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}buildSystemPrompt(e){let t=[];e?.role&&t.push(`# ROLE
You are a ${e.role}.`),e?.background&&t.push(`## BACKGROUND
${e.background}.`),e?.goal&&t.push(`## MAIN GOAL
${e.goal}`),e?.additionalInstructions&&t.push(`## ADDITIONAL INSTRUCTIONS
${e.additionalInstructions}`);let i=e?.toolsList?.length?e.toolsList.join(", "):`
 - None provided`;return t.push(`## TOOL HINTS
You have access to the following tools: ${i}`),t.push(ne),t.join(`

`)}handoffAgentToTools(e){return e.map(t=>O(b(t.name),Q`You are a ${t.name}. Use this tool to ${t.goal??t.background}`,z.object({prompt:z.string().describe("The prompt of the request.")}),async({prompt:i})=>{let o=await t.chat(i);return o?.completion?.content||o}))}toolsToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.schema.function.name} [${b(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.name} [${b(t.name)}]: Its role is to ${t.background}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new s(e)}},k=class s extends x{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new s({...e,position:"orchestrator"})}};export{x as Agent,M as Micro,k as Orchestrator,S as Providers,te as createProvider,O as createTool,D as del,C as get,U as head,$ as http,E as httpClient,K as options,u as parseTemplate,N as patch,I as post,w as put,A as randomId,b as slugify};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map