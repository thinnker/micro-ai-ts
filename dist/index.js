import'dotenv/config';import I from'axios';import k from'hyperid';import S from'dedent';import {z}from'zod';export{z}from'zod';import {zodToJsonSchema}from'zod-to-json-schema';function E(s){let{model:e,...t}=s;return {provider:t,model:e}}var f={openai:(s="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:s}),groq:(s="moonshotai/kimi-k2-instruct-0905")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:s}),gemini:(s="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:s}),ai302:(s="gpt-4o-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:s}),openrouter:(s="anthropic/claude-haiku-4.5")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:s}),deepseek:(s="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:s}),grok:(s="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:s})};function v(){return k({urlSafe:true})()}function a(s,e={}){return s.replace(/\{\{(\w+)\}\}/g,(t,o)=>e[o]!==void 0?String(e[o]):t)}function P(s){let e=s.split(":");return e.length>1?e[1]??s:s}function b(s){let e=s.split(":");return e.length>1?e[0]??"":""}function R(s,e){return new RegExp(`<${e}>`,"i").test(s)}function y(s,e){let t=new RegExp(`<${e}>`,"gi"),o=new RegExp(`</${e}>`,"gi");return s.replace(t,"").replace(o,"")}function M(s,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),o=s.match(t);return o&&o[1]?o[1].trim():""}function _(s){return s.startsWith("data:")&&s.includes(";base64,")}function p(s){return s.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"-").replace(/^-+|-+$/g,"")}function O(s,e=1){return e<=0?[]:e>=s.length?[...s]:s.slice(-e)}var l={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4o-mini",temperature:0,defaultEndpointCompletionSuffix:"/chat/completions"},m=class{axiosInstance;model;systemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;streaming;parsedSystemPrompt;defaultProvider;modelName;providerName;identifier;timeout;reasoning_effort;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;debug;reasoning;isReasoningModel;isGemini25Reasoning;isOpenAIReasoning;isOpenAI5;isGLMReasoning;isQWQ;isDeepseekReasoning;isQwen3;constructor(e={}){this.identifier=v(),this.timeout=e?.timeout,this.modelName=P(e?.model||"")||l.model,this.providerName=b(e?.model||"")||l.providerName;let t;if(this.providerName){let o=f[this.providerName];o&&(t=o(this.modelName));}if(this.defaultProvider={baseURL:t?.baseURL??e?.provider?.baseURL??l.baseURL,apiKey:t?.apiKey??e?.provider?.apiKey??l.apiKey,...e?.provider?.headers&&{headers:e.provider.headers}},!this.defaultProvider.apiKey)throw new Error("API Key is required");this.axiosInstance=I.create({baseURL:this.defaultProvider.baseURL,headers:{Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers},...this.timeout&&{timeout:this.timeout}}),this.model=this.modelName,this.systemPrompt=e?.systemPrompt||"",this.prompt=e?.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?a(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature!==void 0?e.temperature:l.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.debug=e?.debug||false,this.streaming=e?.streaming||false,this.reasoning=e?.reasoning??true,this.reasoning_effort=e.reasoning_effort??"medium",this.isOpenAI5=this.model?.toLowerCase()?.includes("gpt-5"),this.isOpenAIReasoning=this.model?.toLowerCase()?.includes("o1")||this.model?.toLowerCase()?.includes("o3")||this.model?.toLowerCase()?.includes("o4")||this.isOpenAI5,this.isGemini25Reasoning=this.model?.toLowerCase()?.includes("gemini-2.5"),this.isGLMReasoning=this.model?.toLowerCase()?.includes("glm-4."),this.isQWQ=this.model?.toLowerCase()?.includes("qwq"),this.isDeepseekReasoning=this.model?.toLowerCase()?.includes("deepseek-reasoner")||this.model?.toLowerCase()?.includes("deepseek-r1"),this.isQwen3=this.model?.toLowerCase()?.includes("qwen3"),this.isReasoningModel=this.isGemini25Reasoning||this.isOpenAIReasoning||this.isGLMReasoning||this.isQWQ||this.isDeepseekReasoning||this.isQwen3,this.onComplete=e.onComplete||void 0,this.onMessage=e.onMessage||void 0,this.onRequest=e.onRequest||void 0,this.onResponseData=e.onResponseData||void 0,this.onError=e.onError||void 0,this.onToolCall=e.onToolCall||void 0,this.messages=e?.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&(console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",this.defaultProvider),console.log(`=============================================
`));}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){e&&(this.parsedSystemPrompt=a(e,this.context),this.parsedSystemPrompt&&!this.getSystemMessage().length&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt}));}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),o=this.getNonSystemMessages(),i=O(o,e),n=[...t,...i];return this.messages=n,this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let o=a(e,this.context);this.prompt=o,t&&_(t)?this.messages.push({role:"user",content:[{type:"text",text:o},{type:"image_url",image_url:{url:t}}]}):this.messages.push({role:"user",content:o}),this.onMessage&&this.onMessage(this.messages);}setAssistantMessage(e){let t=a(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage&&this.onMessage(this.messages),this}async makeRequest(){let e={model:this.model,messages:this.messages,stream:this.streaming};if(this.temperature&&(e.temperature=this.temperature),this.maxTokens&&(e.max_tokens=this.maxTokens),this.tools&&this.tools.length>0&&(e.tools=this.tools.map(o=>o.schema),this.tool_choice&&(e.tool_choice=this.tool_choice)),this.reasoning&&this.isReasoningModel)if(this.isOpenAIReasoning)e.reasoning_effort=this.reasoning_effort,this.maxTokens&&(e.max_completion_tokens=this.maxTokens,delete e.max_tokens);else if(this.isGemini25Reasoning){let o={minimal:2048,low:4096,medium:8192,high:16384};e.extra_body={google:{thinking_config:{thinking_budget:o[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.isGLMReasoning&&(e.thinking={type:"enabled"});this.onRequest&&this.onRequest(e);let t=await this.axiosInstance.post(l.defaultEndpointCompletionSuffix,e);return this.onResponseData&&this.onResponseData(t.data),t.data}async executeTool(e,t){let o=this.tools?.find(i=>i.schema.function.name===e);if(!o){let i=`Tool "${e}" not found`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:i}),i}try{let i=JSON.parse(t),n=await o.execute(i);return this.onToolCall&&this.onToolCall({toolName:e,arguments:i,result:n}),n}catch(i){let n=`Error executing tool "${e}": ${i.message}`;return this.onToolCall&&this.onToolCall({toolName:e,arguments:t,result:null,error:n}),n}}async handleToolCalls(e){for(let t of e){let o=t.function.name,i=t.function.arguments,n=await this.executeTool(o,i);this.messages.push({role:"tool",tool_call_id:t.id,name:o,content:typeof n=="string"?n:JSON.stringify(n)});}this.onMessage&&this.onMessage(this.messages);}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),i=t.choices?.[0]?.message;if(i&&(this.messages.push(i),this.onMessage&&this.onMessage(this.messages)),i?.tool_calls&&i.tool_calls.length>0)return await this.handleToolCalls(i.tool_calls),this.invoke();let c=Date.now()-e,d="",r=i?.content||"",u=!1;this.reasoning&&this.isReasoningModel&&r&&(R(r,"thinking")?(d=M(r,"thinking"),r=y(r,"thinking"),u=!0):R(r,"think")&&(d=M(r,"think"),r=y(r,"think"),u=!0));let x={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t.usage,timing:{latencyMs:c,latencySeconds:c/1e3},timestamp:new Date().toISOString(),context:this.context,...this.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.isReasoningModel,reasoning_effort:this.reasoning_effort,hasThoughts:u}},completion:{role:i?.role||"assistant",content:r.trim(),reasoning:d.trim(),original:i?.content||""}};return this.onComplete&&this.onComplete(x,this.messages),x}catch(t){let i=Date.now()-e,n={metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:i,latencySeconds:i/1e3},timestamp:new Date().toISOString(),context:this.context},completion:{role:"assistant",content:"",original:""},error:{type:t.code==="ECONNABORTED"?"timeout":"api_error",message:t.message,status:t.response?.status,code:t.code,details:t.response?.data}};return this.onError&&this.onError(n.error),n}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}};function h(s,e,t,o){let i=zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),n=i.properties||{},c=i.required||[];return {schema:{type:"function",function:{name:s,description:e,parameters:{type:"object",properties:n,required:c,additionalProperties:false}}},execute:o}}var w=S`
You are a {{role}}. {{background}}

## MAIN GOAL
{{goal}}

## TOOL HINTS
You have access to the following tools: {{toolsList}}.

## ADDITIONAL INSTRUCTIONS
{{additionalInstructions}}

You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first reflect with '<thought>{your_thoughts}</thought>', then if necessary, use the tools to get the information you need and print your final response with '<final>{your_final_response}</final>'.
Mark your final response with '<final>{your_final_response}</final>' tag if you have finished the task and no longer need to use the tools.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin! Reminder to ALWAYS use the exact characters <final>...<final/> when you provide a definitive answer.
`,N={model:"gpt-4o-mini"},g=class s{client;name;instructions;handoffs;tools;position;model;constructor(e){this.name=e.name,this.instructions=e.instructions,this.handoffs=e.handoffs,this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.instructions,goal:e.instructions,additionalInstructions:e.instructions,toolsList:[this.handoffAgentToStringList(this.handoffs||[]),this.toolsToStringList(this.tools||[])],...e.context||{}};this.client=new m({systemPrompt:w,maxTokens:e.maxTokens||4e3,temperature:e.temperature??0,model:this.model||N.model,debug:e.debug||false,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,streaming:e.streaming,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}handoffAgentToTools(e){return e.map(t=>h(p(t.name),`You are a ${t.name}. Use this tool to ${t.instructions}`,z.object({prompt:z.string().describe("The prompt of the request.")}),async({prompt:o})=>{let i=await t.chat(o);return i?.completion?.content||i}))}toolsToStringList(e){return !e||e.length===0?"None":`
`+e.map(t=>`- ${t.schema.function.name} [${p(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"None":`
`+e.map(t=>`- ${t.name} [${p(t.name)}]: Its role is to ${t.instructions}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new s(e)}},T=class s extends g{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new s({...e,position:"orchestrator"})}};export{g as Agent,m as Micro,T as Orchestrator,f as Providers,E as createProvider,h as createTool,a as parseTemplate,v as randomId,p as slugify};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map