import'dotenv/config';import V from'dedent';import {z as z$1}from'zod';export{z}from'zod';import {zodToJsonSchema}from'zod-to-json-schema';var se=Object.defineProperty;var oe=(s,e)=>{for(var t in e)se(s,t,{get:e[t],enumerable:true});};function ne(s){let{model:e,...t}=s;return {provider:t,model:e}}var S={openai:(s="gpt-4.1-mini")=>({apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",model:s}),groq:(s="llama-3.3-70b-versatile")=>({apiKey:process.env.GROQ_API_KEY||"",baseURL:process.env.GROQ_BASE_URL||"https://api.groq.com/openai/v1",model:s}),gemini:(s="gemini-2.5-flash-lite")=>({apiKey:process.env.GEMINI_API_KEY||"",baseURL:process.env.GEMINI_BASE_URL||"https://generativelanguage.googleapis.com/v1beta/openai",model:s}),ai302:(s="gpt-4.1-mini")=>({apiKey:process.env.AI_302_API_KEY||"",baseURL:process.env.AI_302_BASE_URL||"https://api.302.ai/v1",model:s}),openrouter:(s="openai/gpt-4.1-mini")=>({apiKey:process.env.OPENROUTER_API_KEY||"",baseURL:process.env.OPENROUTER_BASE_URL||"https://openrouter.ai/api/v1",model:s}),deepseek:(s="deepseek-chat")=>({apiKey:process.env.DEEPSEEK_API_KEY||"",baseURL:process.env.DEEPSEEK_BASE_URL||"https://api.deepseek.com/v1",model:s}),grok:(s="grok-4-fast")=>({apiKey:process.env.GROK_API_KEY||"",baseURL:process.env.GROK_BASE_URL||"https://api.x.ai/v1",model:s}),fireworks:(s="accounts/fireworks/models/llama4-maverick-instruct-basic")=>({apiKey:process.env.FIREWORKS_API_KEY||"",baseURL:process.env.FIREWORKS_BASE_URL||"https://api.fireworks.ai/inference/v1",model:s}),mistral:(s="mistral-large-latest")=>({apiKey:process.env.MISTRAL_API_KEY||"",baseURL:process.env.MISTRAL_BASE_URL||"https://api.mistral.ai/v1",model:s}),together:(s="meta-llama/Meta-Llama-3.1-8B-Instruct-Turbo")=>({apiKey:process.env.TOGETHER_API_KEY||"",baseURL:process.env.TOGETHER_BASE_URL||"https://api.together.xyz/v1",model:s}),nscale:(s="meta-llama/Llama-3.1-8B-Instruct")=>({apiKey:process.env.NSCALE_API_KEY||"",baseURL:process.env.NSCALE_BASE_URL||"https://inference.api.nscale.com/v1",model:s})};var Y={};oe(Y,{del:()=>$,get:()=>U,head:()=>q,httpClient:()=>M,options:()=>B,patch:()=>H,post:()=>D,put:()=>K});var ie=["POST","post","PUT","put","PATCH","patch"];async function u(s){let{baseURL:e,endpoint:t,headers:o,body:n,timeout:i,method:r="POST",stream:p=false}=s,c=new AbortController,d=i?setTimeout(()=>c.abort(),i):void 0;try{let l={method:r,headers:o,signal:c.signal};n&&ie.includes(r)&&(l.body=JSON.stringify(n));let a=await fetch(`${e}${t}`,l);if(d&&clearTimeout(d),!a.ok){let f=await a.json().catch(()=>({})),h=new Error(f.error?.message||`HTTP error! status: ${a.status}`);throw h.response={status:a.status,data:f},h.code="HTTP_ERROR",h}return p?a:await a.json()}catch(l){if(d&&clearTimeout(d),l.name==="AbortError"){let a=new Error("Request timeout");throw a.code="ECONNABORTED",a}throw l}}async function M(s){return u(s)}async function U(s){return u({...s,method:"GET"})}async function D(s){return u({...s,method:"POST"})}async function K(s){return u({...s,method:"PUT"})}async function H(s){return u({...s,method:"PATCH"})}async function $(s){return u({...s,method:"DELETE"})}async function q(s){return u({...s,method:"HEAD"})}async function B(s){return u({...s,method:"OPTIONS"})}function A(){return crypto.randomUUID()}function y(s,e={}){return s.replace(/\{\{(\w+)\}\}/g,(t,o)=>e[o]!==void 0?String(e[o]):t)}function G(s){let e=s.split(":");return e.length===2?e[1]||"":e.length===3?`${e[1]}:${e[2]}`:s}function z(s){let e=s.split(":");return e.length>1?e[0]??"":""}function I(s,e){return new RegExp(`<${e}>`,"i").test(s)}function L(s,e){let t=new RegExp(`<${e}>`,"gi"),o=new RegExp(`</${e}>`,"gi");return s.replace(t,"").replace(o,"")}function k(s,e){let t=new RegExp(`<${e}>(.*?)</${e}>`,"is"),o=s.match(t);return o&&o[1]?o[1].trim():""}function j(s){return s.startsWith("data:")&&s.includes(";base64,")}function v(s){return s.toLowerCase().trim().replace(/[^\w\s-]/g,"").replace(/[\s_-]+/g,"_").replace(/^-+|-+$/g,"")}function W(s,e=1){return e<=0?[]:e>=s.length?[...s]:s.slice(-e)}function F(s){return s.filter(e=>e!=="")}function J(s){if(!s)return s;let e={...s};if(e.apiKey&&typeof e.apiKey=="string"){let t=e.apiKey,o=10,n=8,i=o+n;if(t.length>i){let r=t.substring(0,o),p=t.substring(t.length-n),c=t.length-i;e.apiKey=`${r}${"\u2022".repeat(c)}${p}`;}else if(t.length>o){let r=t.substring(0,o);e.apiKey=`${r}${"\u2022".repeat(t.length-o)}`;}else e.apiKey="\u2022".repeat(t.length);}return e}var T={apiKey:process.env.OPENAI_API_KEY||"",baseURL:process.env.OPENAI_BASE_URL||"https://api.openai.com/v1",providerName:"openai",model:"gpt-4.1-mini",defaultEndpointCompletionSuffix:"/chat/completions"},b=class{identifier;baseURL;headers;model;modelName;providerName;defaultProvider;capabilities;debug;streamEnabled;timeout;systemPrompt;parsedSystemPrompt;messages;context;prompt;maxTokens;temperature;tools;tool_choice;reasoning;reasoning_effort;override;maxToolInterations;onComplete;onMessage;onRequest;onResponseData;onError;onToolCall;constructor(e={}){this.identifier=A(),this.timeout=e.timeout??12e4,this.debug=e.debug??false,this.maxToolInterations=e.maxToolInterations??10,this.streamEnabled=e.stream??false,this.modelName=G(e.model||"")||T.model,this.providerName=z(e.model||"")||T.providerName,this.model=this.modelName,this.defaultProvider=this.initializeProvider(e),this.baseURL=this.defaultProvider.baseURL,this.headers=this.buildHeaders(),this.capabilities=this.detectModelCapabilities(),this.reasoning=e.reasoning??this.capabilities.isReasoningModel,this.reasoning_effort=this.reasoning?e.reasoning_effort??"medium":void 0,this.systemPrompt=e.systemPrompt||"",this.prompt=e.prompt||"",this.context=e.context??{},this.parsedSystemPrompt=this.systemPrompt?y(this.systemPrompt,this.context):"",this.maxTokens=e.maxTokens,this.temperature=e.temperature,this.tools=e.tools,this.tool_choice=e.tool_choice,this.override=e.override,this.onComplete=e.onComplete,this.onMessage=e.onMessage,this.onRequest=e.onRequest,this.onResponseData=e.onResponseData,this.onError=e.onError,this.onToolCall=e.onToolCall,this.messages=e.messages??[],this.setSystemPrompt(this.parsedSystemPrompt),this.debug&&this.logDebugInfo();}initializeProvider(e){let t=S[this.providerName],o=t?.(this.modelName),n={baseURL:o?.baseURL??e.provider?.baseURL??T.baseURL,apiKey:o?.apiKey??e.provider?.apiKey??T.apiKey,...e.provider?.headers&&{headers:e.provider.headers}};if(!n.apiKey)throw new Error("API Key is required");return n}buildHeaders(){return {Authorization:`Bearer ${this.defaultProvider.apiKey}`,"Content-Type":"application/json",...this.defaultProvider.headers}}detectModelCapabilities(){let e=this.model.toLowerCase(),t=e.includes("gpt-5"),o=["o1","o3","o4"].some(a=>e.includes(a))||t,n=e.includes("gemini-2.5"),i=e.includes("glm-4."),r=e.includes("qwq"),p=e.includes("deepseek-reasoner")||e.includes("deepseek-r1"),c=e.includes("qwen3"),d=e.includes("-m2");return {isOpenAI5:t,isOpenAIReasoning:o,isGemini25Reasoning:n,isGLMReasoning:i,isQWQ:r,isDeepseekReasoning:p,isQwen3:c,isMinimaxM2:d,isReasoningModel:n||o||i||r||p||c||d}}logDebugInfo(){console.log(`
=============================================`),console.log("Micro INFO:"),console.log("============================================="),console.log("IDENTIFIER:      ",this.identifier),console.log("MODEL NAME:      ",this.modelName),console.log("PROVIDER NAME:   ",this.providerName),console.log("DEFAULT PROVIDER ",J(this.defaultProvider)),console.log(`=============================================
`);}getMetadata(){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:0,latencySeconds:0},timestamp:new Date().toISOString(),context:this.context,...this.capabilities.isReasoningModel&&{isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel,...this.reasoning_effort&&{reasoning_effort:this.reasoning_effort}}}}getSystemPrompt(){return this.parsedSystemPrompt}setSystemPrompt(e){if(!e)return;this.parsedSystemPrompt=y(e,this.context);let t=this.messages.some(o=>o.role==="system");this.parsedSystemPrompt&&!t&&this.messages.unshift({role:"system",content:this.parsedSystemPrompt});}getSystemMessage(){return this.messages.filter(e=>e.role==="system")}getNonSystemMessages(){return this.messages.filter(e=>e.role!=="system")}flushAllMessages(){this.messages=[];}limitMessages(e=5){let t=this.getSystemMessage(),o=this.getNonSystemMessages(),n=W(o,e);return this.messages=[...t,...n],this.messages}getMessages(){return this.messages}setMessages(e){this.messages=e;}setUserMessage(e,t){let o=y(e,this.context);this.prompt=o;let n=t&&j(t)?[{type:"text",text:o},{type:"image_url",image_url:{url:t}}]:o;this.messages.push({role:"user",content:n}),this.onMessage?.(this.messages);}setAssistantMessage(e){let t=y(e,this.context);return this.messages.push({role:"assistant",content:t}),this.onMessage?.(this.messages),this}buildRequestBody(e){let t={model:this.model,messages:this.messages,stream:e||this.streamEnabled};return this.temperature!==void 0&&(t.temperature=this.temperature),this.maxTokens&&(t.max_tokens=this.maxTokens),this.tools?.length&&(t.tools=this.tools.map(o=>o.schema),this.tool_choice&&(t.tool_choice=this.tool_choice)),this.reasoning&&this.capabilities.isReasoningModel&&this.applyReasoningConfig(t),this.override&&(t={...t,...this.override}),t}applyReasoningConfig(e){if(this.capabilities.isOpenAIReasoning)e.reasoning_effort=this.reasoning_effort,this.maxTokens&&(e.max_completion_tokens=this.maxTokens,delete e.max_tokens);else if(this.capabilities.isGemini25Reasoning){let t={minimal:2048,low:4096,medium:8192,high:16384};e.extra_body={google:{thinking_config:{thinking_budget:t[this.reasoning_effort||"medium"],include_thoughts:true}}};}else this.capabilities.isGLMReasoning&&(e.thinking={type:"enabled"});}async makeRequest(e=false){let t=this.buildRequestBody(e);this.onRequest?.(t);let o=await M({baseURL:this.baseURL,endpoint:T.defaultEndpointCompletionSuffix,headers:this.headers,body:t,timeout:this.timeout,method:"POST",stream:e||this.streamEnabled});return e||this.onResponseData?.(o),o}async executeTool(e,t){let o=this.tools?.find(n=>n.schema.function.name===e);if(!o){let n=`Tool "${e}" not found`;return this.onToolCall?.({toolName:e,arguments:t,result:null,error:n}),n}try{let n=JSON.parse(t),i=await o.execute(n);return this.onToolCall?.({toolName:e,arguments:n,result:i}),i}catch(n){let i=`Error executing tool "${e}": ${n.message}`;return this.onToolCall?.({toolName:e,arguments:t,result:null,error:i}),i}}async handleToolCalls(e){let t=e.map(async n=>{let i=await this.executeTool(n.function.name,n.function.arguments);return {role:"tool",tool_call_id:n.id,name:n.function.name,content:typeof i=="string"?i:JSON.stringify(i)}}),o=await Promise.all(t);this.messages.push(...o),this.onMessage?.(this.messages);}extractReasoning(e){let t=e?.reasoning||e?.reasoning_content||"",o=e?.content||"";return I(o,"thinking")?(t=k(o,"thinking"),o=L(o,"thinking")):I(o,"thought")&&(t=k(o,"thought"),o=L(o,"thought")),{reasoning:t,content:o}}buildResponse(e,t,o,n,i){return {metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:e.usage,timing:{latencyMs:t,latencySeconds:t/1e3},timestamp:new Date().toISOString(),context:this.context,isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel||o.length>0,...this.reasoning_effort&&{reasoning_effort:this.reasoning_effort},hasThoughts:o.length>0},fullResponse:e,completion:{role:i?.role||"assistant",content:n.trim(),reasoning:o.trim(),original:i?.content||""}}}buildErrorResponse(e,t){return {metadata:{id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,timing:{latencyMs:t,latencySeconds:t/1e3},timestamp:new Date().toISOString(),context:this.context},completion:{role:"assistant",content:"",original:""},error:{type:e.code==="ECONNABORTED"?"timeout":"api_error",message:e.message,status:e.response?.status,code:e.code,details:e.response?.data}}}async invoke(){let e=Date.now();try{let t=await this.makeRequest(),o=t.choices?.[0]?.message;if(o&&(this.messages.push(o),this.onMessage?.(this.messages)),o?.tool_calls?.length)return await this.handleToolCalls(o.tool_calls),this.invoke();let n=Date.now()-e,{reasoning:i,content:r}=this.extractReasoning(o),p=this.buildResponse(t,n,i,r,o);return this.onComplete?.(p,this.messages),p}catch(t){let o=Date.now()-e,n=this.buildErrorResponse(t,o);return this.onError?.(n.error),Promise.reject(n.error)}}async chat(e,t){return this.setUserMessage(e,t),this.invoke()}buildStreamMetadata(e,t,o){return {id:this.identifier,prompt:this.prompt,providerName:this.providerName,model:this.modelName,tokensUsed:t,timing:{latencyMs:e,latencySeconds:e/1e3},timestamp:new Date().toISOString(),context:this.context,isReasoningEnabled:this.reasoning,isReasoningModel:this.capabilities.isReasoningModel,...this.reasoning_effort&&{reasoning_effort:this.reasoning_effort},hasThoughts:o.length>0}}async*processStream(e,t){let o=e.body?.getReader();if(!o)throw new Error("Stream not available");let n=new TextDecoder,i="",r="",p="assistant",c="",d,l=[];try{for(;;){let{done:Z,value:ee}=await o.read();if(Z)break;c+=n.decode(ee,{stream:!0});let N=c.split(`
`);c=N.pop()||"";for(let te of N){let E=te.trim();if(!(!E||E==="data: [DONE]")&&E.startsWith("data: "))try{let O=JSON.parse(E.slice(6)),m=O.choices?.[0]?.delta;if(this.debug&&m&&console.log("STREAM: Received delta:",JSON.stringify(m,null,2)),m?.role&&(p=m.role),m?.tool_calls)for(let g of m.tool_calls){let R=g.index??l.length;l[R]?(g.id&&(l[R].id=g.id),g.function?.name&&(l[R].function.name=g.function.name),g.function?.arguments&&(l[R].function.arguments+=g.function.arguments)):l[R]={id:g.id||"",type:"function",function:{name:g.function?.name||"",arguments:g.function?.arguments||""}};}let _=m?.reasoning||m?.reasoning_content;(m?.content||_)&&(i+=m.content||"",r+=_||"",yield {delta:m.content,reasoning:_,fullContent:i,done:!1}),O.usage&&(d=O.usage);}catch{}}}let a={role:p,content:i};l.length>0&&(a.tool_calls=l),this.messages.push(a),this.onMessage?.(this.messages);let f=Date.now()-t,h=this.buildStreamMetadata(f,d,r),w={role:p,content:i.trim(),reasoning:r.trim(),original:i},X={metadata:h,completion:w};this.onComplete?.(X,this.messages),yield {delta:"",fullContent:i.trim(),reasoning:r.trim(),done:!0,metadata:h,completion:w};}catch(a){let f=Date.now()-t,h=this.buildErrorResponse(a,f);throw this.onError?.(h.error),h.error}}async stream(e,t){return this.setUserMessage(e,t),this.streamWithToolHandling()}async*streamWithToolHandling(){let e=0;for(;e<this.maxToolInterations;){e++;let t=Date.now();try{let o=await this.makeRequest(!0),n=this.processStream(o,t),i=!1;for await(let r of n)r.done?this.messages[this.messages.length-1]?.tool_calls?.length?i=!0:yield r:yield r;if(i){let r=this.messages[this.messages.length-1];r?.tool_calls&&await this.handleToolCalls(r.tool_calls);continue}break}catch(o){let n=Date.now()-t,i=this.buildErrorResponse(o,n);throw this.onError?.(i.error),i.error}}if(e>=this.maxToolInterations)throw new Error("Max tool call iterations reached")}};function x(s,e,t,o){let n=zodToJsonSchema(t,{target:"openApi3",$refStrategy:"none"}),i=n.properties||{},r=n.required||[];return {schema:{type:"function",function:{name:s,description:e,parameters:{type:"object",properties:i,required:r,additionalProperties:false}}},execute:o}}var ae=V`
You should think step by step in order to complete the task with reasoning divided in Thought/Action/Observation that can repeat multiple times if needed.
You should first think about it, then if necessary, use the tools to get the information you need.
Go back and forth between the tools and the context until you have a complete understanding of the task.
Do not repeat the same tool call in consecutive calls.
Now begin!
`,le={model:"gpt-4o-mini"},P=class s{client;name;background;goal;position;handoffs;tools;model;constructor(e){this.name=e.name,this.background=e.background,this.goal=e.goal,this.handoffs=e.handoffs||[],this.tools=e.tools||[],this.position=e.position,this.model=e.model;let t={role:e.name,background:e.background,goal:e.goal,additionalInstructions:e.additionalInstructions,toolsList:F([this.handoffAgentToStringList(this.handoffs),this.toolsToStringList(this.tools)]),...e.context||{}};this.client=new b({systemPrompt:this.buildSystemPrompt({role:t.role,background:t.background,goal:t.goal,additionalInstructions:t.additionalInstructions,toolsList:t.toolsList||[]}),maxTokens:e.maxTokens,temperature:e.temperature,model:this.model||le.model,debug:!!e.debug,context:t,messages:e.messages,reasoning:e.reasoning,reasoning_effort:e.reasoning_effort,timeout:e.timeout,stream:e.stream,tool_choice:e.tool_choice,onComplete:e.onComplete,onMessage:e.onMessage,onRequest:e.onRequest,onResponseData:e.onResponseData,onError:e.onError,onToolCall:e.onToolCall,...this.handoffs&&this.handoffs.length>0?{tools:[...e.tools||[],...this.handoffAgentToTools(this.handoffs)]}:{tools:e.tools}});}buildSystemPrompt(e){let t=[];e?.role&&t.push(`# ROLE
You are a ${e.role}.`),e?.background&&t.push(`## BACKGROUND
${e.background}.`),e?.goal&&t.push(`## MAIN GOAL
${e.goal}`),e?.additionalInstructions&&t.push(`## ADDITIONAL INSTRUCTIONS
${e.additionalInstructions}`);let o=e?.toolsList?.length?e.toolsList.join(", "):`
 - None provided`;return t.push(`## TOOL HINTS
You have access to the following tools: ${o}`),t.push(ae),t.join(`

`)}handoffAgentToTools(e){return e.map(t=>x(v(t.name),V`You are a ${t.name}. Use this tool to ${t.goal??t.background}`,z$1.object({prompt:z$1.string().describe("The prompt of the request.")}),async({prompt:o})=>{let n=await t.chat(o);return n?.completion?.content||n}))}toolsToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.schema.function.name} [${v(t.schema.function.name)}]: Its role is to ${t.schema.function.description}`).join(`
`)}handoffAgentToStringList(e){return !e||e.length===0?"":`
`+e.map(t=>`- ${t.name} [${v(t.name)}]: Its role is to ${t.background}`).join(`
`)}async invoke(){return this.client.invoke()}async chat(e){return this.addPrompt(e),this.client.invoke()}async stream(e){return this.addPrompt(e),this.client.stream(e)}getMessages(){return this.client.getMessages()}addPrompt(e){this.client.setUserMessage(e);}addAssistantPrompt(e){this.client.setAssistantMessage(e);}getMetadata(){return this.client.getMetadata()}static create(e){return new s(e)}};var C=class s extends P{constructor(e){super({...e,position:"orchestrator"});}static create(e){return new s({...e,position:"orchestrator"})}};export{P as Agent,b as Micro,C as Orchestrator,S as Providers,ne as createProvider,x as createTool,$ as del,U as get,q as head,Y as http,M as httpClient,B as options,y as parseTemplate,H as patch,D as post,K as put,A as randomId,v as slugify};//# sourceMappingURL=index.js.map
//# sourceMappingURL=index.js.map